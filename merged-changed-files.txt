===== build/resources/js/palette/schemas.ts =====
export type ArgDefinition = {
  name: string
  type: 'string' | 'number' | 'date' | 'currency' | 'reference'
  required: boolean
  hint?: string
}

export type FlagDefinition = {
  name: string
  short?: string | null
  type: 'string' | 'number' | 'date' | 'currency' | 'enum' | 'boolean'
  required?: boolean
  hint?: string
  defaultSource?: string
  values?: string[]
}

export type CommandSchema = {
  entity: string
  verb: string
  description?: string
  args: ArgDefinition[]
  flags: FlagDefinition[]
}

const SCHEMAS: Record<string, CommandSchema> = {}

function register(schema: CommandSchema) {
  SCHEMAS[`${schema.entity}.${schema.verb}`] = schema
}

register({
  entity: 'invoice',
  verb: 'create',
  description: 'Create a new invoice',
  args: [
    { name: 'customer', type: 'reference', required: true, hint: 'Customer name or ID' },
    { name: 'amount', type: 'currency', required: true, hint: 'Invoice amount' },
    { name: 'currency', type: 'currency', required: true, hint: 'ISO currency (e.g., USD)' },
  ],
  flags: [
    { name: 'due', short: 'd', type: 'date', hint: 'Due date (YYYY-MM-DD or +30d)', defaultSource: 'customer.payment_terms' },
    { name: 'reference', short: 'r', type: 'string', hint: 'PO number or reference' },
    { name: 'description', type: 'string', hint: 'Description / memo' },
    { name: 'draft', type: 'boolean', hint: 'Save as draft' },
  ],
})

register({
  entity: 'invoice',
  verb: 'list',
  description: 'List invoices',
  args: [],
  flags: [
    { name: 'status', short: 's', type: 'enum', values: ['draft', 'sent', 'posted', 'overdue', 'paid', 'cancelled'], hint: 'Status filter' },
    { name: 'customer', short: 'c', type: 'string', hint: 'Customer filter' },
    { name: 'unpaid', type: 'boolean', hint: 'Unpaid only' },
    { name: 'overdue', type: 'boolean', hint: 'Overdue only' },
    { name: 'from', type: 'date', hint: 'Start date' },
    { name: 'to', type: 'date', hint: 'End date' },
  ],
})

register({
  entity: 'invoice',
  verb: 'view',
  description: 'View an invoice',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Invoice ID or number' },
  ],
  flags: [],
})

register({
  entity: 'invoice',
  verb: 'send',
  description: 'Send an invoice',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Invoice ID or number' },
  ],
  flags: [
    { name: 'email', type: 'boolean', hint: 'Send via email' },
    { name: 'to', type: 'string', hint: 'Recipient email' },
  ],
})

register({
  entity: 'invoice',
  verb: 'void',
  description: 'Void an invoice',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Invoice ID or number' },
  ],
  flags: [
    { name: 'reason', type: 'string', hint: 'Reason' },
  ],
})

register({
  entity: 'invoice',
  verb: 'duplicate',
  description: 'Duplicate an invoice',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Invoice ID or number' },
  ],
  flags: [],
})

register({
  entity: 'payment',
  verb: 'create',
  description: 'Record a payment',
  args: [
    { name: 'invoice', type: 'reference', required: true, hint: 'Invoice number or ID' },
    { name: 'amount', type: 'currency', required: true, hint: 'Payment amount' },
  ],
  flags: [
    { name: 'method', short: 'm', type: 'enum', values: ['cash', 'check', 'card', 'bank_transfer', 'other'], defaultSource: 'user.pref.method' },
    { name: 'reference', short: 'r', type: 'string', hint: 'Reference or note' },
    { name: 'date', short: 'd', type: 'date', hint: 'Payment date', defaultSource: 'system.today' },
  ],
})

register({
  entity: 'payment',
  verb: 'list',
  description: 'List payments',
  args: [],
  flags: [
    { name: 'invoice', type: 'string', hint: 'Invoice filter' },
    { name: 'customer', type: 'string', hint: 'Customer filter' },
    { name: 'method', type: 'enum', values: ['cash', 'check', 'card', 'bank_transfer', 'other'], hint: 'Method filter' },
    { name: 'from', type: 'date', hint: 'Start date' },
    { name: 'to', type: 'date', hint: 'End date' },
  ],
})

register({
  entity: 'payment',
  verb: 'void',
  description: 'Void a payment',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Payment ID or number' },
  ],
  flags: [
    { name: 'reason', type: 'string', hint: 'Reason' },
  ],
})

register({
  entity: 'customer',
  verb: 'create',
  description: 'Create a customer',
  args: [
    { name: 'name', type: 'string', required: true, hint: 'Customer name' },
    { name: 'email', type: 'string', required: false, hint: 'Email' },
    { name: 'currency', type: 'currency', required: false, hint: 'ISO currency' },
  ],
  flags: [
    { name: 'phone', type: 'string', hint: 'Phone' },
    { name: 'payment_terms', short: 't', type: 'number', hint: 'Payment terms (days)' },
  ],
})

register({
  entity: 'customer',
  verb: 'list',
  description: 'List customers',
  args: [],
  flags: [
    { name: 'search', type: 'string', hint: 'Search' },
    { name: 'inactive', type: 'boolean', hint: 'Include inactive' },
    { name: 'limit', type: 'number', hint: 'Limit results' },
  ],
})

register({
  entity: 'customer',
  verb: 'view',
  description: 'View customer',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Customer ID or name' },
  ],
  flags: [],
})

register({
  entity: 'customer',
  verb: 'update',
  description: 'Update customer',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Customer ID or name' },
  ],
  flags: [
    { name: 'email', type: 'string', hint: 'Email' },
    { name: 'phone', type: 'string', hint: 'Phone' },
    { name: 'payment_terms', type: 'number', hint: 'Payment terms' },
    { name: 'currency', type: 'currency', hint: 'Currency' },
  ],
})

register({
  entity: 'customer',
  verb: 'delete',
  description: 'Delete customer',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Customer ID or name' },
  ],
  flags: [],
})

register({
  entity: 'customer',
  verb: 'restore',
  description: 'Restore customer',
  args: [
    { name: 'id', type: 'string', required: true, hint: 'Customer ID or name' },
  ],
  flags: [],
})

register({
  entity: 'company',
  verb: 'create',
  description: 'Create a company',
  args: [
    { name: 'name', type: 'string', required: true, hint: 'Company name' },
    { name: 'currency', type: 'currency', required: true, hint: 'Base currency (ISO)' },
  ],
  flags: [
    { name: 'industry', type: 'string', hint: 'Industry' },
    { name: 'country', type: 'string', hint: 'Country code' },
  ],
})

export function getSchema(entity?: string | null, verb?: string | null): CommandSchema | null {
  if (!entity || !verb) return null
  return SCHEMAS[`${entity}.${verb}`] ?? null
}


===== build/resources/js/palette/scaffold.ts =====
import type { ParsedCommand } from '@/types/palette'
import type { CommandSchema } from './schemas'

export interface ScaffoldState {
  skeleton: string
  pointerLabel: string
  currentArg?: string
  requiredRemaining: string[]
  optionalFlags: Array<{ name: string; value?: string; source?: string; loading?: boolean }>
  ghosts: Array<{ label: string; completed: boolean }>
}

export function buildScaffold(
  parsed: ParsedCommand,
  schema: CommandSchema | null,
  context: { companyName?: string; companyCurrency?: string; defaults?: Record<string, { value: string; source?: string }> }
  ,
  activeArg?: string
): ScaffoldState | null {
  if (!schema) return null

  const tokens: string[] = []
  const requiredRemaining: string[] = []
  const ghosts: Array<{ label: string; completed: boolean }> = []

  schema.args.forEach(arg => {
    const hasValue = Boolean(parsed.flags?.[arg.name] || parsed.subject)
    if (arg.required && !hasValue) {
      requiredRemaining.push(arg.name)
    }
    tokens.push(arg.required ? `<${arg.name}>` : `[${arg.name}]`)
    ghosts.push({ label: arg.name, completed: hasValue })
  })

  const flagChips = schema.flags.map(flag => {
    const def = context.defaults?.[flag.name]
    const value = (parsed.flags?.[flag.name] as string) || def?.value
    const source = parsed.flags?.[flag.name] ? 'user' : def?.source
    return { name: flag.name, value, source }
  })

  const skeleton = `${schema.entity} ${schema.verb} ${tokens.join(' ')}`
  const currentArg = activeArg || requiredRemaining[0]
  const pointerLabel = currentArg
    ? `${currentArg}${schema.args.find(a => a.name === currentArg)?.hint ? ` (${schema.args.find(a => a.name === currentArg)?.hint})` : ''}`
    : 'Ready'

  return {
    skeleton,
    pointerLabel,
    currentArg,
    requiredRemaining,
    optionalFlags: flagChips,
    ghosts,
  }
}


===== build/resources/js/components/palette/CommandPalette.vue =====
<script setup lang="ts">
import { ref, watch, nextTick, computed, onMounted, onUnmounted } from 'vue'
import { parse } from '@/palette/parser'
import { generateSuggestions } from '@/palette/autocomplete'
import { getHelp } from '@/palette/help'
import { formatText } from '@/palette/formatter'
import { getCommandExample, resolveEntityShortcut } from '@/palette/grammar'
import { getQuickActions, resolveQuickActionCommand, getQuickActionLabel } from '@/palette/quick-actions'
import { getSchema } from '@/palette/schemas'
import { buildScaffold } from '@/palette/scaffold'
import { getFrecencyScores, recordCommandUse } from '@/palette/frecency'
import { isPresetShortcut } from '@/palette/shortcuts'
import { usePage } from '@inertiajs/vue3'
import type { ParsedCommand, Suggestion, QuickAction, TableState, OutputLine } from '@/types/palette'

const props = defineProps<{ visible: boolean }>()
const emit = defineEmits<{ 'update:visible': [v: boolean] }>()

type Stage = 'entity' | 'verb'
interface ContextRecord {
  label: string
  value: string
  meta?: string
}

// State
const input = ref('')
const output = ref<OutputLine[]>([])
const history = ref<string[]>(loadHistory())
const historyIndex = ref(-1)
const executing = ref(false)
const suggestions = ref<Suggestion[]>([])
const suggestionIndex = ref(0)
const showSuggestions = ref(false)
const awaitingConfirmation = ref<{
  original: string
  parsed: ParsedCommand
  message: string
} | null>(null)

// Quick actions state
const tableState = ref<TableState | null>(null)
const quickActions = ref<QuickAction[]>([])
const showSubPrompt = ref(false)
const subPromptAction = ref<QuickAction | null>(null)
const subPromptInput = ref('')
const pendingRefreshEntity = ref<string | null>(null)
const stage = ref<Stage>('entity')
const frecencyScores = ref<Record<string, number>>(getFrecencyScores())
const contextRecords = ref<ContextRecord[]>([])
const contextTitle = ref('')
const defaults = ref<Record<string, { value: string; source?: string }>>({})
const cursorIndex = ref(0)
const defaultsLoading = ref(false)
const scaffoldState = computed(() => {
  const schema = getSchema(parsed.value.entity, parsed.value.verb)
  const activeArg = getActiveArgFromCursor(schema)
  const flagsWithState = schema?.flags?.map(flag => ({
    ...flag,
    loading: defaultsLoading.value && !defaults.value[flag.name]?.value,
  })) || []
  return buildScaffold(parsed.value, schema ? { ...schema, flags: flagsWithState } : null, {
    companyName: activeCompany.value?.name,
    companyCurrency: activeCompany.value?.base_currency ?? activeCompany.value?.currency,
    defaults: defaults.value,
  }, activeArg)
})

const validationHint = computed(() => {
  const schema = getSchema(parsed.value.entity, parsed.value.verb)
  if (!schema) return ''
  const missing = schema.args.filter(arg => arg.required && !parsed.value.flags?.[arg.name])
  if (missing.length > 0) {
    const arg = missing[0]
    return `Need ${arg.name}${arg.hint ? ` (${arg.hint})` : ''}`
  }
  return ''
})

// Parsed command (reactive)
const parsed = computed(() => parse(input.value))

// Inline placeholder hint (ghosted text showing example)
const placeholderHint = computed(() => {
  // Don't show if suggestions are visible
  if (showSuggestions.value) return ''

  // Don't show if executing
  if (executing.value) return ''

  // Don't show if awaiting confirmation
  if (awaitingConfirmation.value) return ''

  const trimmed = input.value.trim()
  const parsedCmd = parse(trimmed)

  // Only show if we have entity + verb
  if (!parsedCmd.entity || !parsedCmd.verb) return ''

  const example = getCommandExample(parsedCmd.entity, parsedCmd.verb)

  // Only show the remaining part (what user hasn't typed yet)
  if (example && example.startsWith(trimmed)) {
    return example.slice(trimmed.length)
  }

  return ''
})

// Width of typed text for positioning ghost text
const typedTextWidth = ref('0px')

// Dynamic suggestions fetch timeout
const fetchTimeout = ref<number | null>(null)
const fetchAbort = ref<AbortController | null>(null)

const tabActionLabel = computed(() => {
  if (showSuggestions.value) return 'select'
  if (parsed.value.complete) return 'run'
  return 'select'
})

// Refs
const inputEl = ref<HTMLInputElement>()
const outputEl = ref<HTMLDivElement>()
const subPromptInputEl = ref<HTMLInputElement>()

// Company context
const page = usePage()
const initialCompany = computed(() => (page.props.auth as any)?.currentCompany)
const activeCompany = ref(initialCompany.value || null)
const companySlug = computed(() => activeCompany.value?.slug || '')

// Focus on open
watch(() => props.visible, (v) => {
  if (v) {
    nextTick(() => inputEl.value?.focus())
    document.addEventListener('keydown', handleKeydown)
  } else {
    showSuggestions.value = false
    historyIndex.value = -1
    document.removeEventListener('keydown', handleKeydown)
  }
})

// Auto-scroll output
watch(() => output.value.length, () => {
  nextTick(() => {
    if (outputEl.value) outputEl.value.scrollTop = outputEl.value.scrollHeight
  })
})

watch(parsed, (val) => {
  handleContextRecords(val)
  resolveDefaults(val)
})

// Update suggestions on input
watch(input, async (val) => {
  // Calculate text width for ghost text positioning
  if (inputEl.value) {
    const canvas = document.createElement('canvas')
    const ctx = canvas.getContext('2d')
    if (ctx) {
      const style = window.getComputedStyle(inputEl.value)
      ctx.font = style.font
      const width = ctx.measureText(val).width
      typedTextWidth.value = `${width}px`
    }
  }

  stage.value = determineStage(val)
  await refreshSuggestions(val)
}, { immediate: true })

// Watch output for table data to populate tableState
watch(output, (newOutput) => {
  const lastTable = newOutput.slice().reverse().find(line => line.type === 'table')

  if (!lastTable) {
    tableState.value = null
    return
  }

  // Get the last command that was executed
  const lastInput = newOutput.slice().reverse().find(line => line.type === 'input')
  if (!lastInput) {
    return
  }

  // Parse the command to get entity and verb
  const cmd = String(lastInput.content).replace('‚ùØ ', '')
  const parsedCmd = parse(cmd)

  if (!parsedCmd.entity || !parsedCmd.verb) {
    return
  }

  // Populate tableState
  tableState.value = {
    headers: lastTable.headers || [],
    rows: lastTable.content as string[][],
    selectedRowIndex: 0,
    entity: parsedCmd.entity,
    verb: parsedCmd.verb,
  }
}, { deep: true })

// Watch tableState to update quickActions
watch(tableState, (newState) => {
  if (!newState) {
    quickActions.value = []
    return
  }

  const actions = getQuickActions(newState.entity, newState.verb)
  quickActions.value = actions
})

function close() {
  emit('update:visible', false)
  input.value = ''
  showSuggestions.value = false
  stage.value = 'entity'
  contextRecords.value = []
  contextTitle.value = ''
  if (fetchTimeout.value) clearTimeout(fetchTimeout.value)
}

async function refreshSuggestions(val: string) {
  const trimmed = val.trim()
  const parsedCmd = parse(trimmed)
  const tokens = trimmed ? trimmed.split(/\s+/) : []
  const inferredEntity = parsedCmd.entity || resolveEntityShortcut(tokens[0] || '') || ''

  // Hide suggestions when awaiting confirmation
  if (awaitingConfirmation.value) {
    showSuggestions.value = false
    return
  }

  // Show placeholder hint instead of suggestions when both entity+verb are present and user added trailing space
  if (tokens.length === 2 && val.endsWith(' ') && parsedCmd.entity && parsedCmd.verb) {
    showSuggestions.value = false
    return
  }

  const suggestionStage: Stage = stage.value === 'verb' && inferredEntity ? 'verb' : 'entity'
  const baseSuggestions = await generateFieldSuggestions(trimmed, parsedCmd, suggestionStage, inferredEntity)

  suggestions.value = baseSuggestions
  showSuggestions.value = baseSuggestions.length > 0
  suggestionIndex.value = 0

  // If no suggestions and scaffold has a current arg, show a placeholder hint
  if (!showSuggestions.value) {
    const scaffold = scaffoldState.value
    if (scaffold?.currentArg) {
      suggestions.value = [{
        type: 'command',
        value: val,
        label: `<${scaffold.currentArg}>`,
        description: scaffold.pointerLabel,
        icon: '‚å®Ô∏è',
      }]
      showSuggestions.value = true
      suggestionIndex.value = 0
    }
  }

  if (!parsedCmd.entity || !parsedCmd.verb) return
  if (tokens.length <= 2) return

  const dynamic = await fetchDynamicSuggestions(parsedCmd.entity, parsedCmd.verb, tokens.slice(2).join(' '))
  if (dynamic.length > 0) {
    suggestions.value = [...dynamic, ...baseSuggestions].slice(0, 8)
    showSuggestions.value = true
    suggestionIndex.value = 0
  }
}

/**
 * Fetch dynamic suggestions from backend (debounced)
 */
async function fetchDynamicSuggestions(
  entity: string,
  verb: string,
  partial: string
): Promise<Suggestion[]> {
  if (fetchTimeout.value) clearTimeout(fetchTimeout.value)
  fetchAbort.value?.abort()

  return new Promise((resolve) => {
    fetchTimeout.value = window.setTimeout(async () => {
      fetchAbort.value = new AbortController()
      try {
        const params = new URLSearchParams({
          entity,
          verb,
          q: partial,
        })

        const res = await fetch(`/api/palette/suggestions?${params}`, {
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          signal: fetchAbort.value.signal,
        })

        if (!res.ok) {
          resolve([])
          return
        }

        const data = await res.json()
        const dynamicSuggestions = (data.suggestions || []).map((s: any) => ({
          type: 'value' as const,
          value: `${entity} ${verb} ${s.value}`,
          label: s.label,
          description: s.description,
          icon: s.icon,
        }))

        resolve(dynamicSuggestions)
      } catch (e) {
        if (e instanceof DOMException && e.name === 'AbortError') {
          resolve([])
        } else {
          console.error('Failed to fetch palette suggestions:', e)
          resolve([])
        }
      }
    }, 250)
  })
}

function addOutput(type: OutputLine['type'], content: string | string[][], headers?: string[], footer?: string) {
  output.value.push({ type, content, headers, footer })
  // Keep max 200 lines
  if (output.value.length > 200) {
    output.value = output.value.slice(-200)
  }
}

function determineStage(val: string): Stage {
  const trimmed = val.trim()
  if (!trimmed) return 'entity'
  const tokens = trimmed.split(/\s+/)
  if (tokens.length === 0) return 'entity'

  const first = tokens[0]
  const isShortcut = isPresetShortcut(first)
  const resolved = resolveEntityShortcut(first)

  if ((resolved || isShortcut) && (trimmed.endsWith(' ') || tokens.length > 1)) {
    return 'verb'
  }

  return 'entity'
}

async function handleContextRecords(parsedCmd: ParsedCommand) {
  if (parsedCmd.entity === 'payment' && parsedCmd.verb === 'create') {
    contextTitle.value = 'Recent unpaid invoices'
    if (contextRecords.value.length === 0) {
      contextRecords.value = await loadRecentInvoices()
    }
    return
  }

  contextTitle.value = ''
  contextRecords.value = []
}

async function loadRecentInvoices(): Promise<ContextRecord[]> {
  try {
    const res = await fetch('/api/palette/invoices/recent', {
      credentials: 'same-origin',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })

    if (!res.ok) return []
    const invoices = await res.json()
    return (invoices || []).slice(0, 5).map((inv: any) => ({
      label: inv.number || inv.id,
      value: inv.number || inv.id,
      meta: inv.meta?.customer
        ? `${inv.meta.customer}${inv.meta.amount ? ` ¬∑ ${inv.meta.amount}` : ''}`
        : inv.meta?.amount,
    }))
  } catch (e) {
    console.error('Failed to load recent invoices', e)
    return []
  }
}

function applyContextRecord(record: ContextRecord) {
  const base = input.value.trim()
  const parsedCmd = parse(base)
  const entity = parsedCmd.entity || resolveEntityShortcut(base.split(/\s+/)[0] || '') || 'payment'
  const verb = parsedCmd.verb || 'create'
  input.value = `${entity} ${verb} --invoice=${record.value} `
  stage.value = 'verb'
  showSuggestions.value = false
  focusInput()
}

function applyFlagChip(flag: { name: string; value?: string }) {
  const existing = input.value.trim()
  const append = flag.value ? ` --${flag.name}=${flag.value}` : ` --${flag.name}=`
  input.value = `${existing}${append}`.trim() + ' '
  focusInput()
}

function handleCursor() {
  const el = inputEl.value
  if (el) {
    cursorIndex.value = el.selectionStart || 0
  }
}

function getActiveArgFromCursor(schema: any): string | undefined {
  if (!schema || !input.value) return undefined
  // Remove prompt parts
  const beforeCursor = input.value.slice(0, cursorIndex.value)
  const tokens = beforeCursor.trimEnd().split(/\s+/).filter(Boolean)
  // tokens[0] = entity, tokens[1] = verb, args follow
  const argIndex = Math.max(0, tokens.length - 2)
  const args = schema.args || []
  return args[argIndex]?.name
}

async function generateFieldSuggestions(
  trimmed: string,
  parsedCmd: ParsedCommand,
  stage: 'entity' | 'verb',
  inferredEntity: string
): Promise<Suggestion[]> {
  // Default grammar-based suggestions
  const base = generateSuggestions(trimmed, {
    stage,
    entity: inferredEntity,
    frecencyScores: frecencyScores.value,
  })

  const schema = getSchema(parsedCmd.entity, parsedCmd.verb)
  const currentArg = scaffoldState.value?.currentArg

  if (!schema || !currentArg) return base

  // Field-aware suggestions
  if (parsedCmd.entity === 'invoice' && parsedCmd.verb === 'create') {
    if (currentArg === 'customer') {
      const q = trimmed.split(/\s+/).pop() || ''
      const customers = await fetchCatalog(`/api/palette/customers?q=${encodeURIComponent(q)}`)
      const mapped = customers.slice(0, 5).map((c: any) => ({
        type: 'entity' as const,
        value: `${schema.entity} ${schema.verb} ${c.name} `,
        label: c.name,
        description: c.meta?.outstanding,
        icon: 'üë§',
      }))
      return mapped.length ? mapped : base
    }
    if (currentArg === 'currency') {
      const currency = activeCompany.value?.base_currency
      if (currency) {
        return [{
          type: 'flag',
          value: `${trimmed} ${currency}`.trim(),
          label: currency,
          description: 'Company base currency',
          icon: 'üí±',
        }]
      }
    }
  }

  if (parsedCmd.entity === 'payment' && parsedCmd.verb === 'create') {
    if (currentArg === 'invoice') {
      const q = trimmed.split(/\s+/).pop() || ''
      const invoices = await fetchCatalog('/api/palette/invoices/recent')
      const filtered = invoices.filter((i: any) =>
        i.number?.toLowerCase().includes(q.toLowerCase()) ||
        i.meta?.customer?.toLowerCase().includes(q.toLowerCase())
      )
      const mapped = filtered.slice(0, 5).map((i: any) => ({
        type: 'entity' as const,
        value: `${schema.entity} ${schema.verb} ${i.number} `,
        label: i.number,
        description: `${i.meta?.customer || ''} ${i.meta?.amount ? `¬∑ ${i.meta.amount}` : ''}`,
        icon: 'üìÑ',
      }))
      return mapped.length ? mapped : base
    }
  }

  if (parsedCmd.entity === 'customer' && parsedCmd.verb === 'create') {
    if (currentArg === 'currency') {
      const currency = activeCompany.value?.base_currency
      if (currency) {
        return [{
          type: 'flag',
          value: `${trimmed} ${currency}`.trim(),
          label: currency,
          description: 'Company base currency',
          icon: 'üí±',
        }]
      }
    }
  }

  return base
}

async function fetchCatalog(url: string): Promise<any[]> {
  try {
    const res = await fetch(url, {
      credentials: 'same-origin',
      headers: { 'Accept': 'application/json' },
    })
    if (!res.ok) return []
    return await res.json()
  } catch (e) {
    console.error('Catalog fetch failed', e)
    return []
  }
}

async function resolveDefaults(parsedCmd: ParsedCommand) {
  const schema = getSchema(parsedCmd.entity, parsedCmd.verb)
  if (!schema) return

  defaultsLoading.value = true
  const nextDefaults: Record<string, { value: string; source?: string }> = {}

  // Invoice create: customer currency/payment_terms
  if (parsedCmd.entity === 'invoice' && parsedCmd.verb === 'create') {
    const customerName = parsedCmd.flags?.customer as string
    if (customerName) {
      const customers = await fetchCatalog(`/api/palette/customers?q=${encodeURIComponent(customerName)}`)
      const match = customers.find((c: any) =>
        c.name?.toLowerCase() === customerName.toLowerCase() ||
        c.id === customerName
      )
      if (match?.meta?.currency) {
        nextDefaults.currency = { value: match.meta.currency, source: 'customer' }
      } else if (activeCompany.value?.base_currency) {
        nextDefaults.currency = { value: activeCompany.value.base_currency, source: 'company' }
      }
      if (match?.meta?.payment_terms) {
        nextDefaults.due = { value: `+${match.meta.payment_terms}d`, source: 'customer' }
      }
    } else if (activeCompany.value?.base_currency) {
      nextDefaults.currency = { value: activeCompany.value.base_currency, source: 'company' }
    }
  }

  // Payment create: invoice balance/currency
  if (parsedCmd.entity === 'payment' && parsedCmd.verb === 'create') {
    const invoiceToken = parsedCmd.flags?.invoice as string
    if (invoiceToken) {
      const invoices = await fetchCatalog('/api/palette/invoices/recent')
      const match = invoices.find((i: any) =>
        i.number?.toLowerCase() === invoiceToken.toLowerCase() ||
        i.id === invoiceToken
      )
      if (match?.meta?.amount) {
        nextDefaults.amount = { value: match.meta.amount.replace(/[^\d.]/g, ''), source: 'invoice.balance' }
      }
      if (match?.meta?.amount_currency) {
        nextDefaults.currency = { value: match.meta.amount_currency, source: 'invoice' }
      }
    }
  }

  defaults.value = nextDefaults
  defaultsLoading.value = false
}

// Destructive actions requiring confirmation
const DESTRUCTIVE_ACTIONS = [
  'company.delete',
  'user.delete',
  'role.delete',
  'user.deactivate',
]

async function execute() {
  const cmd = input.value.trim()
  if (!cmd || executing.value) return

  showSuggestions.value = false

  // Check if we're awaiting confirmation
  if (awaitingConfirmation.value) {
    if (cmd.toLowerCase() === 'yes') {
      // User confirmed - execute the original command
      const { parsed } = awaitingConfirmation.value
      awaitingConfirmation.value = null
      await executeCommand(parsed)
    } else {
      // User cancelled
      addOutput('output', '{secondary}Cancelled{/}')
      awaitingConfirmation.value = null
    }
    input.value = ''
    focusInput()
    return
  }

  // Handle built-in commands
  if (cmd === 'clear' || cmd === 'cls') {
    output.value = []
    input.value = ''
    focusInput()
    return
  }

  if (cmd === 'help' || cmd.startsWith('help ')) {
    const topic = cmd.slice(5).trim() || undefined
    const helpText = getHelp(topic)
    addOutput('output', helpText)
    addToHistory(cmd)
    input.value = ''
    focusInput()
    return
  }

  if (cmd === '?' || cmd.startsWith('?')) {
    const topic = cmd.slice(1).trim()
    const helpText = getHelp(topic ? `? ${topic}` : '?')
    addOutput('output', helpText)
    addToHistory(cmd)
    input.value = ''
    focusInput()
    return
  }

  // Parse command
  const parsed = parse(cmd)

  if (parsed.errors.length > 0) {
    addOutput('input', `‚ùØ ${cmd}`)
    addOutput('error', `{error}‚úó{/} ${parsed.errors.join(', ')}`)
    input.value = ''
    focusInput()
    return
  }

  if (!parsed.entity || !parsed.verb) {
    addOutput('input', `‚ùØ ${cmd}`)
    addOutput('error', `{error}‚úó{/} Unknown command. Type 'help' for available commands.`)
    input.value = ''
    focusInput()
    return
  }

  // Check if destructive
  const actionKey = `${parsed.entity}.${parsed.verb}`
  if (DESTRUCTIVE_ACTIONS.includes(actionKey)) {
    // Show confirmation prompt
    const entityName = String(parsed.flags.slug || parsed.flags.email || parsed.flags.name || 'this item')
    addOutput('input', `‚ùØ ${cmd}`)
    addOutput('warning', `{warning}‚ö†Ô∏è  Delete ${entityName}?{/}`)
    addOutput('warning', `{warning}Type 'yes' to confirm, or anything else to cancel{/}`)

    awaitingConfirmation.value = {
      original: cmd,
      parsed: parsed,
      message: `Confirm deletion`,
    }
    addToHistory(cmd)
    input.value = ''
    focusInput()
    return
  }

  // Normal execution
  await executeCommand(parsed)
  input.value = ''
  focusInput()
}

async function executeCommand(parsed: ParsedCommand) {
  const cmd = parsed.raw
  const resolvedCompanySlug = getRequestCompanySlug(parsed)
  const requiresCompany = needsCompanyContext(parsed)

  // Clear quick actions when new command executes
  tableState.value = null
  quickActions.value = []
  showSubPrompt.value = false
  subPromptAction.value = null
  subPromptInput.value = ''

  addOutput('input', `‚ùØ ${cmd}`)
  addToHistory(cmd)
  recordCommandUse(cmd)
  frecencyScores.value = getFrecencyScores()
  executing.value = true

  try {
    // Require company context for tenant commands
    if (requiresCompany && !resolvedCompanySlug) {
      addOutput('error', `{error}‚úó{/} Company context required. Switch into a company or include --slug.`)
      return
    }

    // Read-only verbs that shouldn't use idempotency (always fetch fresh)
    const readOnlyVerbs = ['list', 'view', 'get', 'show']
    const isReadOnly = readOnlyVerbs.includes(parsed.verb)

    // For read operations, add timestamp to ensure fresh data
    const headers: Record<string, string> = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'X-Action': `${parsed.entity}.${parsed.verb}`,
      'X-CSRF-TOKEN': getCsrfToken(),
      'Cache-Control': 'no-cache, no-store, must-revalidate',
      'Pragma': 'no-cache',
    }

    if (resolvedCompanySlug) {
      headers['X-Company-Slug'] = resolvedCompanySlug
    }

    // Only use idempotency for write operations
    if (!isReadOnly) {
      // ALWAYS generate a fresh idempotency key with timestamp
      // Don't use parsed.idemKey as it's deterministic (same command = same key)
      headers['X-Idempotency-Key'] = generateIdemKey(parsed)
    } else {
      // For read ops, add timestamp to bust any backend caching
      headers['X-Request-Time'] = Date.now().toString()
    }

    const res = await fetch('/api/commands', {
      method: 'POST',
      credentials: 'same-origin',
      cache: 'no-store', // Prevent browser caching
      headers,
      body: JSON.stringify({ params: parsed.flags }),
    })

    const data = await res.json()

    if (data.ok) {
      // Table response
      if (data.data?.headers && data.data?.rows) {
        addOutput('table', data.data.rows, data.data.headers, data.data.footer)
      } 
      // Message response
      else if (data.message) {
        addOutput('success', `{success}‚úì{/} ${data.message}`)
      }
      // Generic success
      else {
        addOutput('success', '{success}‚úì{/} Done')
      }

      // After deletes, refresh the list to show updated rows
      if (parsed.verb === 'delete' && parsed.entity) {
        pendingRefreshEntity.value = parsed.entity
      }

      // Handle redirect
      if (data.redirect) {
        addOutput('output', `{link:${data.redirect}}‚Üí Open in GUI{/}`)
      }

      // Update active company after switch
      if (parsed.entity === 'company' && parsed.verb === 'switch') {
        const payload = data.data || {}
        activeCompany.value = {
          id: payload.id || '',
          name: payload.name || '',
          slug: payload.slug || '',
          user_count: payload.user_count,
          base_currency: payload.base_currency,
          status: payload.status,
        }
      }
    } else {
      const friendly = normalizePermissionError(data.message)
      addOutput('error', `{error}‚úó{/} ${friendly}`)
      if (data.errors) {
        Object.entries(data.errors).forEach(([field, messages]) => {
          addOutput('error', `{error}  ${field}:{/} ${(messages as string[]).join(', ')}`)
        })
      }
    }
  } catch (e) {
    addOutput('error', `{error}‚úó{/} Network error: ${e instanceof Error ? e.message : 'Unknown'}`)
  } finally {
    executing.value = false
    const refreshEntity = pendingRefreshEntity.value
    pendingRefreshEntity.value = null
    focusInput()
    if (refreshEntity) {
      input.value = `${refreshEntity} list`
      execute()
    }
  }
}

function handleKeydown(e: KeyboardEvent) {
  if (!props.visible) return

  if (showSubPrompt.value) {
    if (e.key === 'Escape') {
      e.preventDefault()
      closeSubPrompt()
    }
    return
  }

  // Escape - close
  if (e.key === 'Escape') {
    if (showSuggestions.value) {
      showSuggestions.value = false
    } else {
      close()
    }
    return
  }

  // Enter - execute or accept suggestion
  if (e.key === 'Enter') {
  if (showSuggestions.value && suggestions.value.length > 0) {
    e.preventDefault()
    acceptSuggestion()
  } else {
    execute()
    }
    return
  }

  // Space - commit entity during stage 1
  if (
    e.key === ' ' &&
    stage.value === 'entity' &&
    showSuggestions.value &&
    !input.value.includes(' ')
  ) {
    e.preventDefault()
    acceptSuggestion(true)
    return
  }

  // Tab - accept suggestion or execute complete command; keep focus inside palette
  if (e.key === 'Tab') {
    e.preventDefault()
    const backwards = e.shiftKey
    if (showSuggestions.value && suggestions.value.length > 0) {
      const wasEntityStage = stage.value === 'entity'
      acceptSuggestion(wasEntityStage)
      nextTick(() => {
        const newParsed = parse(input.value)
        if (wasEntityStage) {
          stage.value = 'verb'
          refreshSuggestions(input.value)
        } else if (stage.value === 'verb' && newParsed.complete) {
          execute()
        }
      })
      return
    }

    // No suggestions: move through required args in order
    const scaffold = scaffoldState.value
    if (scaffold) {
      const schema = getSchema(parsed.value.entity, parsed.value.verb)
      const argOrder = schema?.args.filter(a => a.required).map(a => a.name) || []
      const current = scaffold.currentArg
      let target = current
      if (argOrder.length) {
        const idx = argOrder.indexOf(current || '')
        if (backwards) {
          target = argOrder[Math.max(0, idx <= 0 ? argOrder.length - 1 : idx - 1)]
        } else {
          target = argOrder[Math.min(argOrder.length - 1, idx < 0 ? 0 : idx + 1)]
        }
      }
      if (target) {
        moveCursorToArg(target)
        refreshSuggestions(input.value)
      }
      return
    }

    if (parsed.value.complete) {
      execute()
    }
    return
  }

  // Arrow navigation
  if (e.key === 'ArrowUp') {
    e.preventDefault()
    if (showSuggestions.value) {
      suggestionIndex.value = Math.max(0, suggestionIndex.value - 1)
    } else if (tableState.value && tableState.value.rows.length > 0) {
      // Navigate table rows
      const newIndex = Math.max(0, tableState.value.selectedRowIndex - 1)
      tableState.value.selectedRowIndex = newIndex
    } else if (history.value.length && historyIndex.value < history.value.length - 1) {
      historyIndex.value++
      input.value = history.value[historyIndex.value]
    }
    return
  }

  if (e.key === 'ArrowDown') {
    e.preventDefault()
    if (showSuggestions.value) {
      suggestionIndex.value = Math.min(suggestions.value.length - 1, suggestionIndex.value + 1)
    } else if (tableState.value && tableState.value.rows.length > 0) {
      // Navigate table rows
      const newIndex = Math.min(tableState.value.rows.length - 1, tableState.value.selectedRowIndex + 1)
      tableState.value.selectedRowIndex = newIndex
    } else if (historyIndex.value > 0) {
      historyIndex.value--
      input.value = history.value[historyIndex.value]
    } else if (historyIndex.value === 0) {
      historyIndex.value = -1
      input.value = ''
    }
    return
  }

  // Number keys (0-9) - trigger quick actions
  if (quickActions.value.length > 0 && /^[0-9]$/.test(e.key)) {
    const action = quickActions.value.find(a => a.key === e.key)
    if (action) {
      e.preventDefault()
      handleQuickAction(action)
      return
    }
  }

  // Ctrl+L - clear
  if (e.key === 'l' && e.ctrlKey) {
    e.preventDefault()
    output.value = []
    return
  }

  // Ctrl+U - clear input
  if (e.key === 'u' && e.ctrlKey) {
    e.preventDefault()
    input.value = ''
    return
  }
}

function acceptSuggestion(advanceStage = false) {
  const suggestion = suggestions.value[suggestionIndex.value] || suggestions.value[0]
  if (!suggestion) return

  // Use the value from the suggestion
  input.value = suggestion.value
  showSuggestions.value = false
  stage.value = advanceStage ? 'verb' : determineStage(input.value)
  nextTick(() => inputEl.value?.focus())
}

function moveCursorToArg(arg: string) {
  // Simple strategy: append placeholder if missing
  if (!input.value.includes(` ${arg}`) && !input.value.includes(`--${arg}`)) {
    input.value = `${input.value.trim()} ${arg} `.trim()
  }
  focusInput()
}

function selectSuggestion(index: number) {
  suggestionIndex.value = index
  acceptSuggestion()
}

function addToHistory(cmd: string) {
  history.value = [cmd, ...history.value.filter(h => h !== cmd)].slice(0, 100)
  historyIndex.value = -1
  saveHistory()
}

function loadHistory(): string[] {
  try {
    return JSON.parse(localStorage.getItem('palette-history') || '[]')
  } catch {
    return []
  }
}

function saveHistory() {
  try {
    localStorage.setItem('palette-history', JSON.stringify(history.value))
  } catch { /* ignore */ }
}

function getCsrfToken(): string {
  return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
}

function generateIdemKey(parsed: ParsedCommand): string {
  const parts = [parsed.entity, parsed.verb, Date.now(), JSON.stringify(parsed.flags)]
  return btoa(parts.join('|')).substring(0, 32)
}

function needsCompanyContext(parsed: ParsedCommand): boolean {
  const key = `${parsed.entity}.${parsed.verb}`
  const globalCommands = new Set([
    'company.list',
    'company.create',
    'company.switch',
    'help',
    'clear',
  ])
  return !globalCommands.has(key)
}

function normalizePermissionError(message?: string): string {
  if (!message) return 'Command failed'
  if (message.includes('There is no permission named')) {
    return `${message} (permissions cache likely stale ‚Äî run app:sync-permissions and app:sync-role-permissions)`
  }
  return message
}

function getRequestCompanySlug(parsed: ParsedCommand): string {
  const flags = parsed.flags as Record<string, unknown>
  const fromFlags = ['slug', 'company', 'id'].map((key) => {
    const val = flags?.[key]
    return typeof val === 'string' ? val.trim() : ''
  }).find(Boolean) || ''

  return companySlug.value || fromFlags || getSlugFromTableState()
}

function getSlugFromTableState(): string {
  const state = tableState.value
  if (!state) return ''

  const rowIndex = state.selectedRowIndex
  if (rowIndex < 0 || rowIndex >= state.rows.length) return ''

  const slugIndex = state.headers.findIndex(h => h.toLowerCase().replace(/\s+/g, '') === 'slug')
  if (slugIndex === -1) return ''

  return state.rows[rowIndex]?.[slugIndex] || ''
}

// Handle quick action click
function handleQuickAction(action: QuickAction) {
  // Check if action needs row selection
  if (action.needsRow && (!tableState.value || tableState.value.selectedRowIndex < 0)) {
    return
  }

  // Check if action needs sub-prompt
  if (action.prompt) {
    subPromptAction.value = action
    subPromptInput.value = ''
    showSubPrompt.value = true
    nextTick(() => subPromptInputEl.value?.focus())
    return
  }

  // Execute directly
  const resolved = resolveQuickActionCommand(action.command, tableState.value)
  if (resolved) {
    input.value = resolved
    execute()
  }
}

// Select row in table
function selectRow(rowIndex: number) {
  if (tableState.value) {
    tableState.value.selectedRowIndex = rowIndex
  }
  focusInput()
}

// Close sub-prompt modal
function closeSubPrompt() {
  showSubPrompt.value = false
  subPromptAction.value = null
  subPromptInput.value = ''
  focusInput()
}

// Confirm sub-prompt and execute
function confirmSubPrompt() {
  if (!subPromptAction.value || !subPromptInput.value.trim()) return

  // Resolve command with row data first
  let resolved = resolveQuickActionCommand(subPromptAction.value.command, tableState.value)

  // If command still has placeholders or is null, use the base command
  if (!resolved) {
    resolved = subPromptAction.value.command
  }

  // Append the user input
  const finalCommand = `${resolved} ${subPromptInput.value.trim()}`

  // Execute
  input.value = finalCommand
  closeSubPrompt()
  execute()
}

// Click outside to close suggestions
function handleClickOutside(e: MouseEvent) {
  const target = e.target as HTMLElement
  if (!target.closest('.palette')) {
    showSuggestions.value = false
  }
}

onMounted(() => {
  document.addEventListener('click', handleClickOutside)
})

onUnmounted(() => {
  document.removeEventListener('click', handleClickOutside)
  document.removeEventListener('keydown', handleKeydown)
})

function focusInput() {
  nextTick(() => inputEl.value?.focus())
}
</script>

<template>
  <Teleport to="body">
    <!-- Backdrop -->
    <div v-if="visible" class="palette-backdrop" @click="close" />

    <!-- Palette -->
    <div v-if="visible" class="palette">
      <!-- Header - simplified -->
      <div class="palette-header">
        <div class="palette-company">
          <span class="palette-dot" :class="{ 'palette-dot--active': activeCompany }"></span>
          {{ activeCompany?.name || 'Global' }}
        </div>
        <span class="palette-esc">Esc to close</span>
      </div>

      <!-- Main content area with sidebar -->
      <div class="palette-body">
        <!-- Main output and input area -->
        <div class="palette-main">
          <!-- Output -->
          <div ref="outputEl" class="palette-output">
        <template v-if="output.length === 0">
          <div class="palette-empty">
            Type a command or <span class="palette-cmd">help</span> for available commands
          </div>
        </template>
        <template v-for="(line, i) in output" :key="i">
          <!-- Table with row selection -->
          <div v-if="line.type === 'table'" class="palette-table">
            <div class="table-wrapper">
              <!-- Table headers -->
              <div v-if="line.headers && line.headers.length" class="table-header">
                <div
                  v-for="(header, colIndex) in line.headers"
                  :key="colIndex"
                  class="table-cell table-cell--header"
                >
                  {{ header }}
                </div>
              </div>
              <!-- Table rows -->
              <div
                v-for="(row, rowIndex) in (line.content as string[][])"
                :key="rowIndex"
                class="table-row"
                :class="{
                  'table-row--selected': tableState && i === output.length - 1 && rowIndex === tableState.selectedRowIndex
                }"
                @click="selectRow(rowIndex)"
              >
                <div
                  v-for="(cell, colIndex) in row"
                  :key="colIndex"
                  class="table-cell"
                >
                  {{ cell }}
                </div>
              </div>
              <!-- Table footer -->
              <div v-if="line.footer" class="table-footer">
                {{ line.footer }}
              </div>
            </div>
          </div>
          <!-- Text lines -->
      <div
        v-else
        class="palette-line"
        :class="{
          'palette-line--input': line.type === 'input',
          'palette-line--error': line.type === 'error',
          'palette-line--success': line.type === 'success',
          'palette-line--warning': line.type === 'warning',
        }"
        v-html="formatText(String(line.content))"
      ></div>
        </template>
      </div>

      <!-- Input area -->
      <div class="palette-input-area">
        <div class="palette-input-row">
          <span class="palette-prompt" :class="{ 'palette-prompt--busy': executing }">
            {{ executing ? '‚ãØ' : '‚ùØ' }}
          </span>
          <div class="palette-input-container">
            <input
              ref="inputEl"
              v-model="input"
              type="text"
              class="palette-input"
              :disabled="executing"
              placeholder="Type a command..."
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              @click="handleCursor"
              @keyup="handleCursor"
              @keydown="handleCursor"
            />
            <span
              v-if="scaffoldState?.ghosts?.length"
              class="palette-placeholder-hint"
              :style="{ '--typed-text-width': typedTextWidth }"
            >
              <template v-for="ghost in scaffoldState.ghosts" :key="ghost.label">
                <span :class="ghost.completed ? 'ghost-complete' : 'ghost-pending'">
                  {{ ghost.completed ? ghost.label : `<${ghost.label}>` }}
                </span>
                <span class="ghost-sep"> </span>
              </template>
            </span>
          </div>
          <div v-if="executing" class="palette-loading">
            <div class="palette-spinner"></div>
            <span class="palette-loading-text">Executing...</span>
          </div>
        </div>

        <!-- Skeleton zone -->
        <div v-if="scaffoldState" class="palette-skeleton">
          <div class="skeleton-row">
            <span class="skeleton-text">{{ scaffoldState.skeleton }}</span>
          </div>
          <div class="skeleton-pointer">
            <span class="skeleton-arrow">‚Üë</span>
            <span class="skeleton-hint">{{ scaffoldState.pointerLabel }}</span>
            <span v-if="cursorIndex" class="skeleton-cursor">cursor: {{ cursorIndex }}</span>
          </div>
          <div class="skeleton-flags">
            <button
              v-for="flag in scaffoldState.optionalFlags"
              :key="flag.name"
              class="flag-chip"
              @click="applyFlagChip(flag)"
            >
              --{{ flag.name }}
              <span v-if="flag.value" class="flag-value">={{ flag.value }}</span>
              <span v-if="flag.source" class="flag-source" :title="flag.source">*</span>
              <span v-if="defaultsLoading && !flag.value" class="flag-loading">‚Ä¶</span>
            </button>
          </div>
          <div class="skeleton-status">
            <span v-if="scaffoldState.requiredRemaining.length">Required: {{ scaffoldState.requiredRemaining.join(', ') }}</span>
            <span v-else>Ready</span>
            <span class="status-optional">Optional: flags</span>
            <span v-if="validationHint" class="status-hint">{{ validationHint }}</span>
          </div>
        </div>

        <!-- Dropdown below input -->
        <div v-if="showSuggestions && suggestions.length" class="palette-dropdown">
          <div
            v-for="(suggestion, index) in suggestions"
            :key="suggestion.value"
            class="dropdown-item"
            :class="{ 'dropdown-item--selected': index === suggestionIndex }"
            @click="selectSuggestion(index)"
            @mouseenter="suggestionIndex = index"
          >
            <span class="dropdown-icon">{{ suggestion.icon || 'üì¶' }}</span>
            <div class="dropdown-text">
              <span class="dropdown-label">{{ suggestion.label }}</span>
              <span v-if="stage === 'verb' && suggestion.description" class="dropdown-desc">
                {{ suggestion.description }}
              </span>
            </div>
            <kbd v-if="index === suggestionIndex">Tab</kbd>
          </div>
        </div>

        <!-- Helper bar -->
        <div class="palette-helper">
          <span class="palette-stage">
            {{ stage === 'entity' ? 'Entity' : 'Verb' }}
          </span>
          <div class="palette-keys">
            <span><kbd>‚Üë‚Üì</kbd> navigate</span>
            <span><kbd>Tab</kbd> {{ tabActionLabel }}</span>
            <span><kbd>Esc</kbd> close</span>
          </div>
        </div>

        <div v-if="contextRecords.length" class="palette-context">
          <div class="palette-context__title">{{ contextTitle }}</div>
          <div class="palette-context__chips">
            <button
              v-for="record in contextRecords"
              :key="record.value"
              class="palette-context__chip"
              @click="applyContextRecord(record)"
            >
              <span class="palette-context__label">{{ record.label }}</span>
              <span v-if="record.meta" class="palette-context__meta">{{ record.meta }}</span>
            </button>
          </div>
        </div>

      </div>
        </div>

        <!-- Quick Actions Sidebar -->
        <div v-if="quickActions.length > 0" class="palette-sidebar">
          <div class="sidebar-header">
            Quick Actions
            <span v-if="tableState" class="sidebar-debug">
              ({{ tableState.entity }}.{{ tableState.verb }})
            </span>
          </div>
          <div class="sidebar-actions">
            <div
              v-for="action in quickActions"
              :key="action.key"
              class="sidebar-action"
            :class="{
              'sidebar-action--needs-row': action.needsRow && !tableState,
              'sidebar-action--disabled': action.needsRow && (!tableState || tableState.selectedRowIndex < 0)
            }"
            @click="handleQuickAction(action)"
            :aria-label="`Quick action ${action.key}: ${getQuickActionLabel(action, tableState)}`"
          >
              <span class="action-key">{{ action.key }}</span>
              <span class="action-label">{{ getQuickActionLabel(action, tableState) }}</span>
            </div>
        </div>
        <div class="sidebar-hint">
          Press the shown number keys (0-9)
          <template v-if="tableState">
            <br />
            <span class="hint-small">Use ‚Üë‚Üì to select row</span>
          </template>
        </div>
        </div>
      </div>
    </div>

    <!-- Sub-Prompt Modal -->
    <div v-if="showSubPrompt && subPromptAction" class="subprompt-backdrop" @click="closeSubPrompt">
      <div class="subprompt-modal" @click.stop>
        <div class="subprompt-header">
          <span class="subprompt-title">{{ subPromptAction.label }}</span>
          <button class="subprompt-close" @click="closeSubPrompt">‚úï</button>
        </div>
        <div class="subprompt-body">
          <p class="subprompt-prompt">{{ subPromptAction.prompt }}</p>
          <input
            ref="subPromptInputEl"
            v-model="subPromptInput"
            type="text"
            class="subprompt-input"
            placeholder="Enter value..."
            @keydown.enter="confirmSubPrompt"
            @keydown.esc="closeSubPrompt"
          />
        </div>
        <div class="subprompt-footer">
          <button class="subprompt-btn subprompt-btn--cancel" @click="closeSubPrompt">
            Cancel
          </button>
          <button class="subprompt-btn subprompt-btn--confirm" @click="confirmSubPrompt">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </Teleport>
</template>

<style scoped>
/* Single dark theme - no switching */
.palette-backdrop {
  position: fixed;
  inset: 0;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.15) 50%, transparent);
  z-index: 9998;
}

.palette {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80vw;
  height: 80vh;
  max-width: 1400px;
  max-height: calc(100vh - 40px);
  background: #0f172a;
  border: 1px solid #334155;
  border-radius: 16px;
  font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Consolas', monospace;
  font-size: 14px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  box-shadow:
    0 0 0 1px rgba(255, 255, 255, 0.05),
    0 20px 50px rgba(0, 0, 0, 0.5);
  overflow: hidden;
}

/* Body with sidebar */
.palette-body {
  display: flex;
  flex: 1;
  min-height: 0;
}

.palette-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Header */
.palette-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: #1e293b;
  border-bottom: 1px solid #334155;
  font-size: 13px;
}

.palette-company {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 500;
  color: #e2e8f0;
}

.palette-dot {
  width: 8px;
  height: 8px;
  background: #475569;
  border-radius: 50%;
}

.palette-dot--active {
  background: #22d3ee;
}

.palette-esc {
  font-size: 11px;
  color: #64748b;
}

/* Output */
.palette-output {
  flex: 1;
  overflow-y: auto;
  padding: 12px 14px;
  min-height: 120px;
}

.palette-output::-webkit-scrollbar {
  width: 6px;
}

.palette-output::-webkit-scrollbar-track {
  background: transparent;
}

.palette-output::-webkit-scrollbar-thumb {
  background: #334155;
  border-radius: 3px;
}

.palette-output::-webkit-scrollbar-thumb:hover {
  background: #475569;
}

.palette-empty {
  color: #64748b;
  text-align: center;
  padding: 40px 20px;
}

.palette-cmd {
  color: #22d3ee;
  background: rgba(34, 211, 238, 0.1);
  padding: 2px 6px;
  border-radius: 4px;
}

.palette-line {
  color: #e2e8f0;
  line-height: 1.7;
  white-space: pre-wrap;
  word-break: break-word;
}

.palette-line--input {
  color: #22d3ee;
}

.palette-line--error {
  color: #f43f5e;
}

.palette-line--success {
  color: #10b981;
}
.palette-line--warning {
  color: #f59e0b;
}

.palette-table {
  margin: 8px 0;
}

.palette-table pre {
  margin: 0;
  color: #e2e8f0;
  font-family: inherit;
  font-size: 13px;
  line-height: 1.5;
  overflow-x: auto;
}

/* Custom table with row selection */
.table-wrapper {
  border: 1px solid #334155;
  border-radius: 6px;
  overflow: hidden;
}

.table-header {
  display: flex;
  background: rgba(34, 211, 238, 0.1);
  border-bottom: 1px solid #334155;
}

.table-row {
  display: flex;
  border-bottom: 1px solid #334155;
  cursor: pointer;
  transition: background 0.1s;
}

.table-row:last-child {
  border-bottom: none;
}

.table-row:hover {
  background: rgba(34, 211, 238, 0.05);
}

.table-row--selected {
  background: rgba(34, 211, 238, 0.15) !important;
  border-left: 3px solid #22d3ee;
}

.table-cell {
  flex: 1;
  padding: 8px 12px;
  color: #e2e8f0;
  font-size: 12px;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.table-cell--header {
  font-weight: 600;
  color: #22d3ee;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.5px;
}

.table-footer {
  padding: 8px 12px;
  background: rgba(0, 0, 0, 0.2);
  border-top: 1px solid #334155;
  color: #64748b;
  font-size: 11px;
  text-align: right;
}

/* Input area */
.palette-input-area {
  position: relative;
  border-top: 1px solid #334155;
  background: #1e293b;
  display: flex;
  flex-direction: column;
}

.palette-input-row {
  display: flex;
  align-items: center;
  padding: 12px 14px;
}

.palette-prompt {
  color: #22d3ee;
  margin-right: 10px;
  font-weight: 600;
  transition: color 0.15s;
  flex-shrink: 0;
}

.palette-prompt--busy {
  color: #f59e0b;
}

.palette-input-container {
  position: relative;
  flex: 1;
  min-width: 0;
}

.palette-input {
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  color: #e2e8f0;
  font: inherit;
  caret-color: #22d3ee;
  position: relative;
  z-index: 2;
}

.palette-input::placeholder {
  color: #475569;
}

.palette-input:disabled {
  opacity: 0.5;
}

.palette-placeholder-hint {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #475569;
  opacity: 0.5;
  white-space: nowrap;
  font: inherit;
  z-index: 1;
  padding-left: var(--typed-text-width, 0);
}

.ghost-complete {
  color: #64748b;
}

.ghost-pending {
  color: #94a3b8;
}

.ghost-sep {
  opacity: 0;
}

/* Helper */
.palette-dropdown {
  border-top: 1px solid #334155;
  max-height: 200px;
  overflow-y: auto;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  cursor: pointer;
  transition: background 0.1s;
}

.dropdown-item:hover {
  background: rgba(34, 211, 238, 0.05);
}

.dropdown-item--selected {
  background: rgba(34, 211, 238, 0.1);
}

.dropdown-item--selected .dropdown-label {
  color: #22d3ee;
}

.dropdown-icon {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

.dropdown-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex: 1;
  min-width: 0;
}

.dropdown-label {
  font-weight: 500;
  color: #e2e8f0;
  font-size: 13px;
  min-width: 100px;
}

.dropdown-desc {
  color: #64748b;
  font-size: 12px;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dropdown-item kbd {
  font-size: 10px;
  padding: 2px 8px;
  background: rgba(34, 211, 238, 0.15);
  border: 1px solid rgba(34, 211, 238, 0.3);
  border-radius: 4px;
  color: #22d3ee;
  margin-left: auto;
}

.palette-helper {
  display: flex;
  align-items: center;
  padding: 8px 14px;
  border-top: 1px solid rgba(51, 65, 85, 0.5);
  font-size: 11px;
  color: #64748b;
  gap: 12px;
}

.palette-helper kbd {
  display: inline-block;
  background: rgba(255, 255, 255, 0.06);
  padding: 2px 6px;
  border-radius: 3px;
  margin-right: 4px;
  font-family: inherit;
  font-size: 10px;
}

.palette-stage {
  padding: 3px 10px;
  background: rgba(34, 211, 238, 0.1);
  border: 1px solid rgba(34, 211, 238, 0.25);
  border-radius: 4px;
  color: #22d3ee;
  font-weight: 600;
  font-size: 10px;
  text-transform: uppercase;
}

.palette-keys {
  display: flex;
  gap: 16px;
  margin-left: auto;
}

.palette-skeleton {
  padding: 10px 14px 8px;
  border-top: 1px solid #334155;
  background: rgba(34, 211, 238, 0.04);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.skeleton-row {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  color: #cbd5e1;
  font-size: 13px;
}

.skeleton-pointer {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #94a3b8;
  font-size: 11px;
}

.skeleton-arrow {
  color: #22d3ee;
}

.skeleton-flags {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.flag-chip {
  border: 1px solid rgba(34, 211, 238, 0.3);
  background: rgba(34, 211, 238, 0.08);
  color: #e2e8f0;
  border-radius: 8px;
  padding: 6px 8px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  transition: all 0.12s;
}

.flag-chip:hover {
  border-color: rgba(34, 211, 238, 0.5);
  background: rgba(34, 211, 238, 0.14);
}

.flag-value {
  color: #22d3ee;
}

.flag-source {
  color: #fbbf24;
}

.flag-loading {
  color: #94a3b8;
  font-size: 10px;
}

.skeleton-status {
  display: flex;
  gap: 12px;
  font-size: 11px;
  color: #94a3b8;
}

.status-optional {
  color: #64748b;
}

.status-hint {
  color: #f59e0b;
  margin-left: auto;
}

.palette-context {
  padding: 8px 14px 12px;
  border-top: 1px solid #334155;
  background: rgba(34, 211, 238, 0.04);
}

.palette-context__title {
  font-size: 12px;
  color: #94a3b8;
  margin-bottom: 6px;
}

.palette-context__chips {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.palette-context__chip {
  border: 1px solid rgba(34, 211, 238, 0.3);
  background: rgba(34, 211, 238, 0.08);
  color: #e2e8f0;
  border-radius: 8px;
  padding: 8px 10px;
  cursor: pointer;
  display: inline-flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
  transition: all 0.15s;
}

.palette-context__chip:hover {
  border-color: rgba(34, 211, 238, 0.5);
  background: rgba(34, 211, 238, 0.14);
}

.palette-context__label {
  font-weight: 600;
}

.palette-context__meta {
  font-size: 11px;
  color: #94a3b8;
}

/* Helper suggestions (inline) */

/* Loading indicator */
.palette-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 12px;
  color: #f59e0b;
  font-size: 13px;
}

.palette-spinner {
  width: 14px;
  height: 14px;
  border: 2px solid rgba(34, 211, 238, 0.2);
  border-top-color: #22d3ee;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.palette-loading-text {
  color: #22d3ee;
  font-size: 12px;
}

/* Semantic formatting classes */
.fmt-success {
  color: #10b981;
}

.fmt-error {
  color: #f43f5e;
}

.fmt-warning {
  color: #f59e0b;
}

.fmt-accent {
  color: #22d3ee;
}

.fmt-primary {
  color: #6366f1;
}

.fmt-secondary {
  color: #64748b;
}

.fmt-dim {
  opacity: 0.5;
}

.fmt-code {
  background: rgba(34, 211, 238, 0.1);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: inherit;
  font-size: 13px;
}

.fmt-link {
  color: #22d3ee;
  text-decoration: none;
  border-bottom: 1px dotted #22d3ee;
  cursor: pointer;
}

.fmt-link:hover {
  text-decoration: underline;
  border-bottom-style: solid;
}

/* Quick Actions Sidebar */
.palette-sidebar {
  width: 260px;
  background: #1e293b;
  border-left: 1px solid #334155;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 12px 14px;
  font-size: 12px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid #334155;
}

.sidebar-debug {
  display: block;
  font-size: 10px;
  color: #fbbf24;
  text-transform: none;
  margin-top: 4px;
  font-weight: normal;
}

.sidebar-actions {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.sidebar-action {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  margin-bottom: 6px;
  background: rgba(34, 211, 238, 0.05);
  border: 1px solid rgba(34, 211, 238, 0.2);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
}

.sidebar-action:hover {
  background: rgba(34, 211, 238, 0.1);
  border-color: rgba(34, 211, 238, 0.3);
}

.sidebar-action--disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.sidebar-action--disabled:hover {
  background: rgba(34, 211, 238, 0.05);
  border-color: rgba(34, 211, 238, 0.2);
}

.action-key {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: rgba(34, 211, 238, 0.2);
  color: #22d3ee;
  border-radius: 4px;
  font-weight: 600;
  font-size: 13px;
  flex-shrink: 0;
}

.action-label {
  flex: 1;
  color: #e2e8f0;
  font-size: 12px;
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.sidebar-hint {
  padding: 12px 14px;
  border-top: 1px solid #334155;
  font-size: 11px;
  color: #64748b;
  line-height: 1.5;
}

.hint-small {
  font-size: 10px;
  opacity: 0.7;
}

/* Sub-Prompt Modal */
.subprompt-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.subprompt-modal {
  width: 480px;
  max-width: calc(100vw - 40px);
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 8px;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
  font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Consolas', monospace;
}

.subprompt-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
  border-bottom: 1px solid #334155;
}

.subprompt-title {
  font-size: 14px;
  font-weight: 600;
  color: #e2e8f0;
}

.subprompt-close {
  width: 28px;
  height: 28px;
  background: transparent;
  border: none;
  color: #64748b;
  font-size: 18px;
  cursor: pointer;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.subprompt-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e2e8f0;
}

.subprompt-body {
  padding: 20px 18px;
}

.subprompt-prompt {
  margin: 0 0 14px 0;
  font-size: 13px;
  color: #94a3b8;
  line-height: 1.5;
}

.subprompt-input {
  width: 100%;
  padding: 12px 14px;
  background: #0f172a;
  border: 1px solid #334155;
  border-radius: 6px;
  color: #e2e8f0;
  font-family: inherit;
  font-size: 14px;
  outline: none;
  transition: border-color 0.15s;
}

.subprompt-input:focus {
  border-color: #22d3ee;
}

.subprompt-input::placeholder {
  color: #475569;
}

.subprompt-footer {
  display: flex;
  gap: 10px;
  padding: 16px 18px;
  border-top: 1px solid #334155;
  justify-content: flex-end;
}

.subprompt-btn {
  padding: 8px 16px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  border: none;
}

.subprompt-btn--cancel {
  background: transparent;
  color: #64748b;
  border: 1px solid #334155;
}

.subprompt-btn--cancel:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #94a3b8;
}

.subprompt-btn--confirm {
  background: #22d3ee;
  color: #0f172a;
}

.subprompt-btn--confirm:hover {
  background: #06b6d4;
}
</style>


===== cli-palette.md =====
# Haasib Command Palette ‚Äî Implementation Specification

> **Stack**: Custom Vue 3 component. No terminal emulator libraries.
> **Philosophy**: Terminal aesthetic + modern features. Same API as GUI.

---

## 1. Architecture

### 1.1 Component Tree

```
CommandPalette.vue
‚îú‚îÄ‚îÄ PaletteHeader.vue         # Company context, mode indicator
‚îú‚îÄ‚îÄ PaletteInput.vue          # Input line with prompt and cursor
‚îú‚îÄ‚îÄ PaletteOutput.vue         # Scrollable output history
‚îÇ   ‚îú‚îÄ‚îÄ OutputLine.vue        # Single output line (text, table, progress, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ OutputTable.vue       # Tabular data renderer
‚îú‚îÄ‚îÄ PaletteSuggestions.vue    # Autocomplete dropdown
‚îî‚îÄ‚îÄ PaletteHelp.vue           # Inline help panel
```

### 1.2 State Shape

```typescript
interface PaletteState {
  // UI State
  mode: 'collapsed' | 'half' | 'full'
  visible: boolean
  inputFocused: boolean

  // Input
  input: string
  cursorPosition: number

  // History
  commandHistory: string[]
  historyIndex: number           // -1 = not browsing history

  // Output
  outputLines: OutputLine[]
  maxOutputLines: 500

  // Suggestions
  suggestions: Suggestion[]
  suggestionIndex: number        // -1 = none selected
  showSuggestions: boolean

  // Execution
  executing: boolean
  pendingUndo: UndoAction | null
}

interface OutputLine {
  id: string
  type: 'input' | 'output' | 'error' | 'success' | 'table' | 'progress' | 'system'
  content: string | TableData | ProgressData
  timestamp: number
}

interface Suggestion {
  type: 'command' | 'entity' | 'history' | 'flag'
  value: string
  label: string
  description?: string
  icon?: string
}

interface UndoAction {
  action: string
  params: Record<string, unknown>
  expiresAt: number
  message: string
}
```

### 1.3 File Structure

```
resources/js/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ palette/
‚îÇ       ‚îú‚îÄ‚îÄ CommandPalette.vue
‚îÇ       ‚îú‚îÄ‚îÄ PaletteHeader.vue
‚îÇ       ‚îú‚îÄ‚îÄ PaletteInput.vue
‚îÇ       ‚îú‚îÄ‚îÄ PaletteOutput.vue
‚îÇ       ‚îú‚îÄ‚îÄ PaletteSuggestions.vue
‚îÇ       ‚îú‚îÄ‚îÄ PaletteHelp.vue
‚îÇ       ‚îî‚îÄ‚îÄ renderers/
‚îÇ           ‚îú‚îÄ‚îÄ OutputLine.vue
‚îÇ           ‚îú‚îÄ‚îÄ OutputTable.vue
‚îÇ           ‚îî‚îÄ‚îÄ OutputProgress.vue
‚îú‚îÄ‚îÄ composables/
‚îÇ   ‚îú‚îÄ‚îÄ usePalette.ts           # Main palette state and logic
‚îÇ   ‚îú‚îÄ‚îÄ useCommandParser.ts     # Input ‚Üí parsed command
‚îÇ   ‚îú‚îÄ‚îÄ useCommandExecutor.ts   # API calls, idempotency
‚îÇ   ‚îú‚îÄ‚îÄ useAutocomplete.ts      # Suggestion generation
‚îÇ   ‚îî‚îÄ‚îÄ useCommandHistory.ts    # History persistence
‚îú‚îÄ‚îÄ palette/
‚îÇ   ‚îú‚îÄ‚îÄ grammar.ts              # Command definitions
‚îÇ   ‚îú‚îÄ‚îÄ parser.ts               # Tokenizer and parser
‚îÇ   ‚îú‚îÄ‚îÄ formatter.ts            # Output formatting (colors, tables)
‚îÇ   ‚îî‚îÄ‚îÄ constants.ts            # Keybindings, limits, colors
‚îî‚îÄ‚îÄ stores/
    ‚îî‚îÄ‚îÄ paletteStore.ts         # Pinia store (if needed)
```

---

## 2. Visual Design

### 2.1 Layout

```
COLLAPSED (56px height)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ùØ invoice.create acme 1500_                              [¬Ω] [‚àí] [‚ñ°]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

HALF (50% viewport height)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè¢ Acme Corp                                              [¬Ω] [‚àí] [‚ñ°]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ ‚ùØ invoice.list --unpaid                                                 ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ INV#     Customer        Amount      Due         Status             ‚îÇ ‚îÇ
‚îÇ ‚îÇ 1042     Acme Corp       $1,500      Jan 15      ‚ö† Overdue         ‚îÇ ‚îÇ
‚îÇ ‚îÇ 1043     Beta LLC        $2,200      Jan 20      ‚óê Pending         ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ ‚ùØ _                                                                     ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

FULL (100% viewport height, modal overlay)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè¢ Acme Corp ‚îÇ yasir@acme.com ‚îÇ prod                      [¬Ω] [‚àí] [‚ñ°]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  [Full scrollable output area]                                          ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ùØ _                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 Colors (Posting.sh-inspired semantic system)

**Only 7 semantic colors.** Swap them = new theme. No complexity.

```typescript
// palette/theme.ts
export interface PaletteTheme {
  name: string
  primary: string      // Buttons, key interactive elements, prompt
  secondary: string    // Minor labels, muted interactive elements
  accent: string       // Focus rings, cursors, highlights, links
  background: string   // Main background
  surface: string      // Panels, cards, elevated surfaces
  error: string        // Error messages, destructive actions
  success: string      // Success messages, positive states
  warning: string      // Warnings, overdue, anomalies
}

// Default theme: "Galaxy" (inspired by posting.sh)
export const THEME_GALAXY: PaletteTheme = {
  name: 'galaxy',
  primary: '#6366f1',      // Indigo - buttons, prompt
  secondary: '#64748b',    // Slate - muted text
  accent: '#22d3ee',       // Cyan - cursor, focus, links
  background: '#0f172a',   // Dark slate - main bg
  surface: '#1e293b',      // Lighter slate - panels
  error: '#f43f5e',        // Rose - errors
  success: '#10b981',      // Emerald - success
  warning: '#f59e0b',      // Amber - warnings
}

// Alternative: "Monokai"
export const THEME_MONOKAI: PaletteTheme = {
  name: 'monokai',
  primary: '#a6e22e',      // Green
  secondary: '#75715e',    // Comment gray
  accent: '#66d9ef',       // Cyan
  background: '#272822',   // Dark
  surface: '#3e3d32',      // Lighter
  error: '#f92672',        // Pink
  success: '#a6e22e',      // Green
  warning: '#fd971f',      // Orange
}

// Alternative: "Nord"
export const THEME_NORD: PaletteTheme = {
  name: 'nord',
  primary: '#88c0d0',      // Frost
  secondary: '#4c566a',    // Polar night
  accent: '#8fbcbb',       // Frost
  background: '#2e3440',   // Polar night
  surface: '#3b4252',      // Polar night
  error: '#bf616a',        // Aurora red
  success: '#a3be8c',      // Aurora green
  warning: '#ebcb8b',      // Aurora yellow
}

// Alternative: "Dracula"
export const THEME_DRACULA: PaletteTheme = {
  name: 'dracula',
  primary: '#bd93f9',      // Purple
  secondary: '#6272a4',    // Comment
  accent: '#8be9fd',       // Cyan
  background: '#282a36',   // Background
  surface: '#44475a',      // Current line
  error: '#ff5555',        // Red
  success: '#50fa7b',      // Green
  warning: '#f1fa8c',      // Yellow
}

export const THEMES = {
  galaxy: THEME_GALAXY,
  monokai: THEME_MONOKAI,
  nord: THEME_NORD,
  dracula: THEME_DRACULA,
} as const

export type ThemeName = keyof typeof THEMES
```

**Usage in CSS (via CSS custom properties):**

```css
.palette {
  --primary: v-bind('theme.primary');
  --secondary: v-bind('theme.secondary');
  --accent: v-bind('theme.accent');
  --background: v-bind('theme.background');
  --surface: v-bind('theme.surface');
  --error: v-bind('theme.error');
  --success: v-bind('theme.success');
  --warning: v-bind('theme.warning');

  /* Derived colors (computed from above) */
  --text-primary: color-mix(in srgb, var(--accent) 20%, white);
  --text-secondary: var(--secondary);
  --text-muted: color-mix(in srgb, var(--secondary) 50%, var(--background));
}

/* Then use everywhere */
.palette { background: var(--background); }
.palette-surface { background: var(--surface); }
.palette-prompt { color: var(--primary); }
.palette-cursor { background: var(--accent); }
.palette-success { color: var(--success); }
.palette-error { color: var(--error); }
.palette-link { color: var(--accent); }
.palette-link:hover { text-decoration: underline; }
```

**Syntax highlighting (derived from theme):**

```typescript
// Syntax colors are derived from the 7 semantic colors
export function getSyntaxColors(theme: PaletteTheme) {
  return {
    entity: theme.primary,           // invoice, payment, etc.
    verb: theme.accent,              // .create, .list, etc.
    flag: theme.warning,             // --unpaid, -c, etc.
    string: theme.success,           // "Acme Corp"
    number: theme.warning,           // 1500
    operator: theme.secondary,       // ., =
  }
}
```

**Why this approach:**

| Approach | Colors to manage | Theme switching |
|----------|------------------|-----------------|
| Complex (my original) | 20+ tokens | Hard |
| Posting.sh style | 7 tokens | Trivial |

User preference stored in `localStorage`. Default: `galaxy`.

### 2.3 Typography

```css
.palette {
  font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Consolas', monospace;
  font-size: 14px;
  line-height: 1.6;
  font-feature-settings: 'liga' 1, 'calt' 1;  /* Enable ligatures */
}
```

### 2.4 Cursor

```css
.cursor {
  display: inline-block;
  width: 0.6em;
  height: 1.2em;
  background: var(--cursor-color);
  animation: blink 1s step-end infinite;
  vertical-align: text-bottom;
}

@keyframes blink {
  50% { opacity: 0; }
}

/* Steady cursor when typing */
.palette:focus-within .cursor {
  animation: none;
  opacity: 1;
}
```

---

## 3. Input Handling

### 3.1 Keyboard Map

| Key | Context | Action |
|-----|---------|--------|
| `Cmd/Ctrl + K` | Global | Toggle palette |
| `Escape` | Palette open | Close or shrink |
| `Enter` | Input has text | Execute command |
| `Enter` | Input empty | Show menu (beginner mode) |
| `Tab` | Suggestions visible | Accept suggestion |
| `Tab` | No suggestions | Trigger autocomplete |
| `Shift + Tab` | Suggestions visible | Previous suggestion |
| `‚Üë` | Input empty | Previous history |
| `‚Üë` | Suggestions visible | Previous suggestion |
| `‚Üì` | Suggestions visible | Next suggestion |
| `‚Üì` | Browsing history | Next history |
| `Ctrl + C` | Executing | Cancel execution |
| `Ctrl + L` | Any | Clear output |
| `Ctrl + U` | Any | Clear input line |
| `Ctrl + A` | Any | Cursor to start |
| `Ctrl + E` | Any | Cursor to end |
| `Ctrl + W` | Any | Delete word backward |
| `Cmd/Ctrl + ‚Üë` | Half mode | Expand to full |
| `Cmd/Ctrl + ‚Üì` | Full mode | Shrink to half |

### 3.2 Input Processing

```typescript
// composables/usePaletteInput.ts
export function usePaletteInput() {
  const state = usePaletteState()

  function handleKeyDown(event: KeyboardEvent) {
    const { key, ctrlKey, metaKey, shiftKey } = event

    // Global shortcuts
    if ((ctrlKey || metaKey) && key === 'k') {
      event.preventDefault()
      state.toggle()
      return
    }

    if (!state.visible) return

    // Prevent default for handled keys
    const handled = processKey(key, { ctrl: ctrlKey, meta: metaKey, shift: shiftKey })
    if (handled) event.preventDefault()
  }

  function processKey(key: string, mods: Modifiers): boolean {
    switch (key) {
      case 'Enter':
        if (state.input.trim()) {
          execute()
        } else {
          showBeginnerMenu()
        }
        return true

      case 'Tab':
        if (mods.shift) {
          selectPreviousSuggestion()
        } else {
          acceptSuggestionOrAutocomplete()
        }
        return true

      case 'ArrowUp':
        if (state.showSuggestions) {
          selectPreviousSuggestion()
        } else if (state.input === '') {
          browsePreviousHistory()
        }
        return true

      case 'ArrowDown':
        if (state.showSuggestions) {
          selectNextSuggestion()
        } else if (state.historyIndex >= 0) {
          browseNextHistory()
        }
        return true

      case 'Escape':
        if (state.showSuggestions) {
          state.showSuggestions = false
        } else {
          state.shrinkOrClose()
        }
        return true

      case 'c':
        if (mods.ctrl && state.executing) {
          cancelExecution()
          return true
        }
        return false

      case 'l':
        if (mods.ctrl) {
          clearOutput()
          return true
        }
        return false

      case 'u':
        if (mods.ctrl) {
          state.input = ''
          state.cursorPosition = 0
          return true
        }
        return false

      default:
        return false
    }
  }

  return { handleKeyDown }
}
```

### 3.4 Progressive Scaffold (scaffold zone)

- Schema-driven skeletons for revenue commands (`invoice`, `payment`, `customer`, `company` verbs) render under the input with required args and optional flags.
- Active pointer/hint tracks the next required arg; Tab/Shift+Tab moves through required args. If no suggestions, a placeholder hint appears.
- Flag chips show defaults with source labels (company/customer currency, invoice balance, payment terms) and insert flag stubs on click/tab.
- Parser infers positional args: `invoice create Acme 1200 USD` ‚Üí `customer=Acme, amount=1200, currency=USD`; `payment create INV-1001 500` ‚Üí `invoice=INV-1001, amount=500`; `customer create Acme USD` ‚Üí `name=Acme, currency=USD`.
- Field-aware suggestions surface current-field data (customers, invoices, currencies) using palette catalog endpoints; scaffold consumes schema + company context + resolved defaults.

---

## 4. Grammar

### 4.1 Canonical Form

```
<entity>.<verb> [subject] [flags]
```

Every command resolves to this form. No exceptions.

### 4.2 Entities and Verbs

```typescript
// palette/grammar.ts
export const GRAMMAR = {
  entities: {
    company: {
      verbs: ['create', 'list', 'view', 'update', 'delete', 'switch'],
      shortcuts: ['co'],
    },
    user: {
      verbs: ['create', 'list', 'view', 'update', 'delete', 'assign', 'unassign'],
      shortcuts: ['usr'],
    },
    customer: {
      verbs: ['create', 'list', 'view', 'update', 'delete'],
      shortcuts: ['cust', 'c'],
    },
    vendor: {
      verbs: ['create', 'list', 'view', 'update', 'delete'],
      shortcuts: ['vend', 'v'],
    },
    invoice: {
      verbs: ['create', 'list', 'view', 'send', 'void'],
      shortcuts: ['inv', 'i'],
    },
    payment: {
      verbs: ['create', 'list', 'view', 'void'],
      shortcuts: ['pay', 'p'],
    },
    bill: {
      verbs: ['create', 'list', 'view', 'pay', 'void'],
      shortcuts: ['bl'],
    },
    expense: {
      verbs: ['create', 'list', 'view', 'update', 'delete'],
      shortcuts: ['exp', 'e'],
    },
    account: {
      verbs: ['create', 'list', 'view', 'update', 'reconcile'],
      shortcuts: ['acc', 'a'],
    },
    report: {
      verbs: ['list', 'view', 'export'],
      shortcuts: ['rep', 'r'],
    },
  },

  // Default verb when entity typed alone
  defaultVerb: 'list',

  // Verb synonyms (normalized to canonical)
  verbSynonyms: {
    'new': 'create',
    'add': 'create',
    'make': 'create',
    'rm': 'delete',
    'remove': 'delete',
    'show': 'view',
    'get': 'view',
    'edit': 'update',
    'modify': 'update',
    'ls': 'list',
    'all': 'list',
  },
} as const
```

### 4.3 Flags

```typescript
// palette/grammar.ts
export const FLAGS = {
  // Universal flags (work on all applicable commands)
  universal: {
    '--help':     { short: '-h', type: 'boolean', description: 'Show help' },
    '--format':   { short: '-f', type: 'enum', values: ['table', 'json', 'csv'], description: 'Output format' },
    '--draft':    { short: null, type: 'boolean', description: 'Save without posting' },
  },

  // Entity-specific flags
  invoice: {
    '--customer': { short: '-c', type: 'string', description: 'Customer name or ID' },
    '--amount':   { short: '-a', type: 'money', description: 'Invoice amount' },
    '--due':      { short: '-d', type: 'date', description: 'Due date' },
    '--status':   { short: '-s', type: 'enum', values: ['draft', 'pending', 'sent', 'paid', 'overdue', 'void'], description: 'Filter by status' },
    '--unpaid':   { short: null, type: 'boolean', description: 'Shorthand for --status=pending,sent,overdue' },
    '--overdue':  { short: null, type: 'boolean', description: 'Shorthand for --status=overdue' },
  },

  payment: {
    '--invoice':  { short: '-i', type: 'string', description: 'Invoice ID' },
    '--amount':   { short: '-a', type: 'money', description: 'Payment amount' },
    '--method':   { short: '-m', type: 'enum', values: ['cash', 'check', 'bank', 'card'], description: 'Payment method' },
    '--date':     { short: '-d', type: 'date', description: 'Payment date' },
  },

  report: {
    '--from':     { short: null, type: 'date', description: 'Start date' },
    '--to':       { short: null, type: 'date', description: 'End date' },
    '--period':   { short: '-p', type: 'enum', values: ['today', 'week', 'month', 'quarter', 'year', 'ytd'], description: 'Predefined period' },
  },
} as const
```

### 4.4 Parser

```typescript
// palette/parser.ts
export interface ParsedCommand {
  raw: string
  entity: string | null
  verb: string | null
  subject: string | null
  flags: Record<string, string | boolean | number>
  errors: string[]
  complete: boolean
  confidence: number           // 0-1, how confident we are in the parse
  idemKey: string
}

export function parse(input: string): ParsedCommand {
  const tokens = tokenize(input)
  const result: ParsedCommand = {
    raw: input,
    entity: null,
    verb: null,
    subject: null,
    flags: {},
    errors: [],
    complete: false,
    confidence: 0,
    idemKey: '',
  }

  if (tokens.length === 0) return result

  // Step 1: Extract entity.verb or shortcut
  const [first, ...rest] = tokens
  const entityVerb = parseEntityVerb(first)

  if (entityVerb) {
    result.entity = entityVerb.entity
    result.verb = entityVerb.verb
  } else {
    result.errors.push(`Unknown command: ${first}`)
    return result
  }

  // Step 2: Extract flags
  const { flags, remaining, flagErrors } = extractFlags(rest, result.entity)
  result.flags = flags
  result.errors.push(...flagErrors)

  // Step 3: Remaining tokens are subject
  if (remaining.length > 0) {
    result.subject = remaining.join(' ')
  }

  // Step 4: Infer missing pieces from subject
  inferFromSubject(result)

  // Step 5: Check completeness
  result.complete = isComplete(result)
  result.confidence = calculateConfidence(result)
  result.idemKey = generateIdemKey(result)

  return result
}

function parseEntityVerb(token: string): { entity: string, verb: string } | null {
  // Try entity.verb format
  if (token.includes('.')) {
    const [entity, verb] = token.split('.')
    const normalizedEntity = resolveEntityShortcut(entity)
    const normalizedVerb = resolveVerbSynonym(verb)

    if (normalizedEntity && isValidVerb(normalizedEntity, normalizedVerb)) {
      return { entity: normalizedEntity, verb: normalizedVerb }
    }
  }

  // Try shortcut only (implies default verb)
  const entity = resolveEntityShortcut(token)
  if (entity) {
    return { entity, verb: GRAMMAR.defaultVerb }
  }

  return null
}

function tokenize(input: string): string[] {
  const tokens: string[] = []
  let current = ''
  let inQuotes = false
  let quoteChar = ''

  for (const char of input) {
    if ((char === '"' || char === "'") && !inQuotes) {
      inQuotes = true
      quoteChar = char
    } else if (char === quoteChar && inQuotes) {
      inQuotes = false
      quoteChar = ''
    } else if (char === ' ' && !inQuotes) {
      if (current) {
        tokens.push(current)
        current = ''
      }
    } else {
      current += char
    }
  }

  if (current) tokens.push(current)
  return tokens
}

function extractFlags(
  tokens: string[],
  entity: string
): { flags: Record<string, unknown>; remaining: string[]; flagErrors: string[] } {
  const flags: Record<string, unknown> = {}
  const remaining: string[] = []
  const errors: string[] = []

  let i = 0
  while (i < tokens.length) {
    const token = tokens[i]

    if (token.startsWith('--')) {
      const { name, value, consumed, error } = parseLongFlag(token, tokens[i + 1], entity)
      if (error) errors.push(error)
      else if (name) flags[name] = value
      i += consumed
    } else if (token.startsWith('-') && token.length === 2) {
      const { name, value, consumed, error } = parseShortFlag(token, tokens[i + 1], entity)
      if (error) errors.push(error)
      else if (name) flags[name] = value
      i += consumed
    } else {
      remaining.push(token)
      i++
    }
  }

  return { flags, remaining, flagErrors: errors }
}

function inferFromSubject(result: ParsedCommand) {
  if (!result.subject || !result.entity) return

  const parts = result.subject.split(/\s+/)

  for (const part of parts) {
    // Money pattern: 1500, $1500, 1,500.00
    if (/^\$?[\d,]+\.?\d*$/.test(part) && !result.flags['amount']) {
      result.flags['amount'] = parseMoney(part)
      continue
    }

    // Date pattern: jan15, jan 15, 2025-01-15
    const date = parseDate(part)
    if (date && !result.flags['date'] && !result.flags['due']) {
      if (result.entity === 'invoice' && result.verb === 'create') {
        result.flags['due'] = date
      } else {
        result.flags['date'] = date
      }
      continue
    }

    // Remaining: likely customer/vendor/subject name
    if (!result.flags['customer'] && !result.flags['vendor']) {
      if (['invoice', 'payment'].includes(result.entity)) {
        result.flags['customer'] = part
      } else if (['bill', 'expense'].includes(result.entity)) {
        result.flags['vendor'] = part
      }
    }
  }
}
```

---

## 5. Autocomplete

### 5.1 Trigger Conditions

| Condition | Behavior |
|-----------|----------|
| Empty input | Show recent commands (max 5) |
| Typing (debounce 50ms) | Show matching suggestions |
| Tab with no suggestions | Force generate suggestions |
| After `.` | Show verbs for entity |
| After `--` | Show available flags |
| After flag expecting value | Show valid values |

### 5.2 Suggestion Sources

```typescript
// composables/useAutocomplete.ts
export function useAutocomplete() {
  const state = usePaletteState()
  const { entities, recentCommands, customers, vendors, invoices } = useEntityCatalogs()

  function generateSuggestions(input: string): Suggestion[] {
    const parsed = parse(input)
    const suggestions: Suggestion[] = []

    // Priority 1: Recent matching commands
    if (input.length > 0) {
      const recentMatches = recentCommands
        .filter(cmd => cmd.startsWith(input))
        .slice(0, 3)
        .map(cmd => ({
          type: 'history' as const,
          value: cmd,
          label: cmd,
          icon: '‚è±',
        }))
      suggestions.push(...recentMatches)
    }

    // Priority 2: Entity/verb completions
    if (!parsed.entity) {
      const entityMatches = Object.keys(GRAMMAR.entities)
        .filter(e => e.startsWith(input.toLowerCase()))
        .map(e => ({
          type: 'command' as const,
          value: `${e}.`,
          label: e,
          description: `${GRAMMAR.entities[e].verbs.join(', ')}`,
          icon: getEntityIcon(e),
        }))
      suggestions.push(...entityMatches)
    } else if (parsed.entity && !parsed.verb) {
      const verbMatches = GRAMMAR.entities[parsed.entity].verbs
        .map(v => ({
          type: 'command' as const,
          value: `${parsed.entity}.${v}`,
          label: `${parsed.entity}.${v}`,
          description: getVerbDescription(parsed.entity, v),
          icon: getVerbIcon(v),
        }))
      suggestions.push(...verbMatches)
    }

    // Priority 3: Flag completions
    const lastToken = input.split(/\s+/).pop() || ''
    if (lastToken.startsWith('--')) {
      const flagPrefix = lastToken.slice(2)
      const availableFlags = getAvailableFlags(parsed.entity)
      const flagMatches = Object.keys(availableFlags)
        .filter(f => f.startsWith(flagPrefix))
        .map(f => ({
          type: 'flag' as const,
          value: input.replace(/--\w*$/, `--${f}`),
          label: `--${f}`,
          description: availableFlags[f].description,
          icon: '‚öë',
        }))
      suggestions.push(...flagMatches)
    }

    // Priority 4: Entity value completions (customers, vendors, etc.)
    if (parsed.entity === 'invoice' && parsed.verb === 'create' && !parsed.flags['customer']) {
      const customerMatches = customers
        .filter(c => c.name.toLowerCase().includes(lastToken.toLowerCase()))
        .slice(0, 5)
        .map(c => ({
          type: 'entity' as const,
          value: `${input} ${c.name}`.trim(),
          label: c.name,
          description: c.outstanding ? `$${c.outstanding} outstanding` : '',
          icon: 'üë§',
        }))
      suggestions.push(...customerMatches)
    }

    return suggestions.slice(0, 8)  // Max 8 suggestions
  }

  return { generateSuggestions }
}
```

### 5.3 Suggestion UI

```
‚ùØ inv cr
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚è±  inv create acme 1500                          recent     ‚îÇ  ‚Üê highlighted
  ‚îÇ üìÑ invoice.create         Create new invoice                ‚îÇ
  ‚îÇ üìÑ invoice.create acme    Recent customer                   ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 6. Output Rendering

### 6.1 Line Types

```typescript
type OutputLineType =
  | 'input'      // Echo of executed command
  | 'output'     // Normal text output
  | 'success'    // Success message (green)
  | 'error'      // Error message (red)
  | 'warning'    // Warning message (amber)
  | 'info'       // Info message (blue)
  | 'table'      // Tabular data
  | 'progress'   // Progress bar
  | 'system'     // System message (muted)
```

### 6.2 Text Formatting

Inline formatting syntax (parsed at render time). Uses semantic theme colors:

```
{success}text{/}        ‚Üí success color (green)
{error}text{/}          ‚Üí error color (red)
{warning}text{/}        ‚Üí warning color (amber)
{accent}text{/}         ‚Üí accent color (cyan)
{primary}text{/}        ‚Üí primary color
{secondary}text{/}      ‚Üí secondary/muted color
{bold}text{/}           ‚Üí bold text
{dim}text{/}            ‚Üí dimmed text (50% opacity)
{link:url}text{/}       ‚Üí clickable link (accent color)
{code}text{/}           ‚Üí inline code style (surface bg)
```

```typescript
// palette/formatter.ts
export function formatText(text: string): VNode[] {
  const segments: VNode[] = []
  const regex = /\{(\w+)(?::([^}]+))?\}(.*?)\{\/\}/g
  let lastIndex = 0
  let match

  while ((match = regex.exec(text)) !== null) {
    // Add text before match
    if (match.index > lastIndex) {
      segments.push(h('span', text.slice(lastIndex, match.index)))
    }

    const [, type, arg, content] = match

    switch (type) {
      // Semantic colors (from theme)
      case 'success':
      case 'error':
      case 'warning':
      case 'accent':
      case 'primary':
      case 'secondary':
        segments.push(h('span', { style: { color: `var(--${type})` } }, content))
        break
      case 'bold':
        segments.push(h('span', { style: { fontWeight: 'bold' } }, content))
        break
      case 'dim':
        segments.push(h('span', { style: { opacity: 0.5 } }, content))
        break
      case 'link':
        segments.push(h('a', {
          href: arg,
          class: 'palette-link',
          style: { color: 'var(--accent)' }
        }, content))
        break
      case 'code':
        segments.push(h('code', {
          class: 'palette-code',
          style: {
            background: 'var(--surface)',
            padding: '0.125em 0.25em',
            borderRadius: '0.25em'
          }
        }, content))
        break
    }

    lastIndex = regex.lastIndex
  }

  // Add remaining text
  if (lastIndex < text.length) {
    segments.push(h('span', text.slice(lastIndex)))
  }

  return segments
}
```

### 6.3 Table Rendering

```typescript
// palette/renderers/OutputTable.vue
interface TableData {
  headers: string[]
  rows: (string | number)[][]
  footer?: string
}

// Example output:
// ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
// ‚îÇ INV#     ‚îÇ Customer        ‚îÇ Amount     ‚îÇ Due        ‚îÇ Status    ‚îÇ
// ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
// ‚îÇ 1042     ‚îÇ Acme Corp       ‚îÇ $1,500.00  ‚îÇ Jan 15     ‚îÇ ‚ö† Overdue ‚îÇ
// ‚îÇ 1043     ‚îÇ Beta LLC        ‚îÇ $2,200.00  ‚îÇ Jan 20     ‚îÇ ‚óê Pending ‚îÇ
// ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
//   2 invoices ‚îÇ $3,700.00 total outstanding
```

### 6.4 Progress Bar

```typescript
// palette/renderers/OutputProgress.vue
interface ProgressData {
  label: string
  percent: number
  showPercent: boolean
}

// Example:
// Sending invoices ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 60%
```

### 6.5 Status Indicators

```typescript
// Uses semantic theme colors
export const STATUS_INDICATORS = {
  paid:     { icon: '‚óè', color: 'success', label: 'Paid' },
  pending:  { icon: '‚óê', color: 'warning', label: 'Pending' },
  sent:     { icon: '‚óë', color: 'accent', label: 'Sent' },
  overdue:  { icon: '‚ö†', color: 'error', label: 'Overdue' },
  draft:    { icon: '‚óã', color: 'secondary', label: 'Draft' },
  void:     { icon: '‚äò', color: 'secondary', label: 'Void' },
} as const

// Rendered as:
// <span :style="{ color: `var(--${status.color})` }">{{ status.icon }} {{ status.label }}</span>
```

---

## 7. API Integration

### 7.1 Request Format

```typescript
// POST /api/commands
interface CommandRequest {
  headers: {
    'Content-Type': 'application/json'
    'Authorization': `Bearer ${token}` | session
    'X-Action': string              // e.g., 'invoice.create'
    'X-Idempotency-Key': string     // SHA256 hash
    'X-Company-Slug': string        // Company slug from URL
  }
  body: {
    params: Record<string, unknown>
  }
}
```

### 7.2 Response Format

```typescript
// Success (mutation)
interface SuccessResponse {
  ok: true
  message: string
  data: Record<string, unknown>
  redirect?: string                 // GUI URL to open
  undo?: {
    action: string
    params: Record<string, unknown>
    expiresAt: number               // Unix timestamp
  }
}

// Success (query)
interface QueryResponse {
  ok: true
  data: unknown[]
  meta?: {
    total: number
    page: number
    perPage: number
  }
}

// Error
interface ErrorResponse {
  ok: false
  code: 'VALIDATION' | 'NOT_FOUND' | 'FORBIDDEN' | 'IDEMPOTENT_REPLAY' | 'SERVER_ERROR'
  message: string
  errors?: Record<string, string[]>  // Field-level errors
}
```

### 7.3 Executor

```typescript
// composables/useCommandExecutor.ts
export function useCommandExecutor() {
  const state = usePaletteState()
  const { currentCompany } = useAuth()

  async function execute(parsed: ParsedCommand): Promise<void> {
    if (!parsed.complete) {
      state.addOutput({
        type: 'error',
        content: `Missing: ${getMissingFields(parsed).join(', ')}`,
      })
      return
    }

    // Echo input
    state.addOutput({
      type: 'input',
      content: parsed.raw,
    })

    state.executing = true

    try {
      const response = await fetch('/api/commands', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Action': `${parsed.entity}.${parsed.verb}`,
          'X-Idempotency-Key': parsed.idemKey,
          'X-Company-Id': String(currentCompany.value?.id || ''),
        },
        body: JSON.stringify({
          params: buildParams(parsed),
        }),
      })

      const result = await response.json()

      if (result.ok) {
        handleSuccess(result, parsed)
      } else {
        handleError(result)
      }
    } catch (err) {
      state.addOutput({
        type: 'error',
        content: 'Network error. Check your connection.',
      })
    } finally {
      state.executing = false
      state.addToHistory(parsed.raw)
    }
  }

  function handleSuccess(result: SuccessResponse, parsed: ParsedCommand) {
    // Format based on command type
    if (parsed.verb === 'list' && Array.isArray(result.data)) {
      state.addOutput({
        type: 'table',
        content: formatAsTable(result.data, parsed.entity),
      })
    } else {
      state.addOutput({
        type: 'success',
        content: `{success}‚úì{/} ${result.message}`,
      })
    }

    // Show link if redirect provided
    if (result.redirect) {
      state.addOutput({
        type: 'info',
        content: `{link:${result.redirect}}‚Üí Open in GUI{/}`,
      })
    }

    // Set up undo
    if (result.undo) {
      state.pendingUndo = {
        ...result.undo,
        message: result.message,
      }
      startUndoTimer()
    }
  }

  function handleError(result: ErrorResponse) {
    if (result.code === 'VALIDATION' && result.errors) {
      for (const [field, messages] of Object.entries(result.errors)) {
        state.addOutput({
          type: 'error',
          content: `{error}‚úó{/} ${field}: ${messages.join(', ')}`,
        })
      }
    } else {
      state.addOutput({
        type: 'error',
        content: `{error}‚úó{/} ${result.message}`,
      })
    }
  }

  return { execute }
}
```

---

## 8. History & Persistence

### 8.1 Storage

```typescript
// IndexedDB schema
interface PaletteDB {
  commandHistory: {
    key: number           // Auto-increment
    value: {
      command: string
      timestamp: number
      companyId: number
    }
    indexes: {
      byTimestamp: number
      byCompany: number
    }
  }
  preferences: {
    key: string           // 'mode' | 'fontSize' | etc.
    value: unknown
  }
}
```

### 8.2 History Limits

```typescript
export const HISTORY_CONFIG = {
  maxEntries: 500,
  maxAge: 90 * 24 * 60 * 60 * 1000,  // 90 days
  deduplicateConsecutive: true,
} as const
```

---

## 9. Undo System

### 9.1 Flow

```
1. User executes command
2. Backend returns undo action in response
3. Frontend shows toast: "‚úì Invoice created [Undo - 10s]"
4. Timer counts down
5. User clicks Undo OR timer expires
6. If undo: execute undo action, show confirmation
7. Clear pending undo
```

### 9.2 Toast UI

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úì Invoice INV-1044 created for Acme Corp ($1,500)              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [View]  [Undo - 8s]                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 10. Confirmation System

### 10.1 Action Classification

```typescript
export const ACTION_CLASSIFICATION = {
  safe: [
    '*.list',
    '*.view',
    'report.*',
  ],
  reversible: [
    '*.create',
    '*.update',
    '*.send',
  ],
  destructive: [
    'invoice.void',
    'payment.void',
    'bill.void',
    '*.delete',
  ],
  critical: [
    'company.delete',
  ],
} as const
```

### 10.2 Confirmation UI

**Destructive action:**
```
‚ùØ invoice.void 1042
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚ö† VOID INVOICE                                                 ‚îÇ
  ‚îÇ                                                                ‚îÇ
  ‚îÇ Invoice: INV-1042                                              ‚îÇ
  ‚îÇ Customer: Acme Corp                                            ‚îÇ
  ‚îÇ Amount: $1,500.00                                              ‚îÇ
  ‚îÇ                                                                ‚îÇ
  ‚îÇ This will reverse GL entries.                                  ‚îÇ
  ‚îÇ                                                                ‚îÇ
  ‚îÇ Press Y to confirm, N or Esc to cancel                         ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Critical action:**
```
‚ùØ company.delete acme
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üî¥ DELETE COMPANY                                              ‚îÇ
  ‚îÇ                                                                ‚îÇ
  ‚îÇ Company: Acme Corp                                             ‚îÇ
  ‚îÇ Data: 1,247 invoices, 892 payments, 3 years                    ‚îÇ
  ‚îÇ                                                                ‚îÇ
  ‚îÇ ‚ö† This action is IRREVERSIBLE.                                 ‚îÇ
  ‚îÇ                                                                ‚îÇ
  ‚îÇ Type "delete acme" to confirm:                                 ‚îÇ
  ‚îÇ ‚ùØ _                                                            ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 11. Help System

### 11.1 Triggers

| Input | Shows |
|-------|-------|
| `help` or `?` | Global help |
| `help invoice` | Invoice commands |
| `invoice.create --help` | Create invoice syntax |
| Unknown command | "Did you mean...?" |

### 11.2 Help Content Structure

```typescript
interface HelpContent {
  global: {
    quickStart: Example[]
    navigation: Shortcut[]
    modules: ModuleOverview[]
  }
  entities: Record<string, {
    description: string
    commands: CommandHelp[]
  }>
  commands: Record<string, {
    usage: string
    description: string
    arguments: ArgumentHelp[]
    flags: FlagHelp[]
    examples: Example[]
  }>
}
```

---

## 12. Accessibility

### 12.1 Requirements

| Requirement | Implementation |
|-------------|----------------|
| Focus management | Focus trap when palette open |
| Screen reader | `role="dialog"`, `aria-label`, `aria-live="polite"` for output |
| Keyboard navigation | All actions reachable via keyboard |
| Focus visible | 2px ring on interactive elements |
| Motion | Respect `prefers-reduced-motion` |
| Contrast | WCAG AA minimum (4.5:1) |

### 12.2 ARIA Attributes

```html
<div
  role="dialog"
  aria-label="Command palette"
  aria-modal="true"
>
  <div role="log" aria-live="polite" aria-label="Command output">
    <!-- Output lines -->
  </div>

  <input
    role="combobox"
    aria-autocomplete="list"
    aria-controls="suggestions"
    aria-expanded="true/false"
    aria-activedescendant="suggestion-0"
  />

  <ul id="suggestions" role="listbox">
    <li id="suggestion-0" role="option" aria-selected="true">...</li>
  </ul>
</div>
```

---

## 13. Performance

### 13.1 Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Keypress ‚Üí suggestions | < 50ms | `performance.now()` |
| Enter ‚Üí optimistic feedback | < 30ms | `performance.now()` |
| Enter ‚Üí server confirmed | < 300ms p50 | Round-trip |
| Output scroll | 60fps | No jank |
| Memory | < 50MB | DevTools |

### 13.2 Optimizations

1. **Debounce suggestions**: 50ms after keypress
2. **Virtual scrolling**: For output > 100 lines
3. **Memoize parsing**: Cache parse results by input
4. **Web Worker**: Heavy operations (search, formatting)
5. **Preload catalogs**: Customers, vendors on mount

---

## 14. Testing

### 14.1 Unit Tests

```typescript
// tests/unit/parser.test.ts
describe('parse', () => {
  test('parses entity.verb', () => {
    const result = parse('invoice.create')
    expect(result.entity).toBe('invoice')
    expect(result.verb).toBe('create')
  })

  test('expands shortcuts', () => {
    expect(parse('inv').entity).toBe('invoice')
    expect(parse('inv').verb).toBe('list')
  })

  test('extracts flags', () => {
    const result = parse('invoice.list --unpaid --customer=acme')
    expect(result.flags.unpaid).toBe(true)
    expect(result.flags.customer).toBe('acme')
  })

  test('infers amount from subject', () => {
    const result = parse('invoice.create acme 1500')
    expect(result.flags.customer).toBe('acme')
    expect(result.flags.amount).toBe(1500)
  })
})
```

### 14.2 Component Tests

```typescript
// tests/component/PaletteInput.test.ts
describe('PaletteInput', () => {
  test('shows cursor at end of input', () => {
    const wrapper = mount(PaletteInput, { props: { modelValue: 'test' } })
    expect(wrapper.find('.cursor').exists()).toBe(true)
  })

  test('emits on Enter', async () => {
    const wrapper = mount(PaletteInput)
    await wrapper.find('input').trigger('keydown', { key: 'Enter' })
    expect(wrapper.emitted('execute')).toBeTruthy()
  })
})
```

### 14.3 E2E Tests

```typescript
// tests/e2e/palette.spec.ts
test('executes invoice.list', async ({ page }) => {
  await page.goto('/dashboard')
  await page.keyboard.press('Meta+k')
  await page.keyboard.type('invoice.list --unpaid')
  await page.keyboard.press('Enter')

  await expect(page.locator('[data-testid="palette-output"]'))
    .toContainText('INV#')
})
```

---

## 15. Migration Path

### Phase 1: Foundation (Week 1-2)
- [ ] Core components: Palette, Input, Output
- [ ] Keyboard handling
- [ ] Basic parser (entity.verb only)
- [ ] Connect to existing `/api/commands`

### Phase 2: Intelligence (Week 3-4)
- [ ] Full parser with flags, inference
- [ ] Autocomplete
- [ ] History
- [ ] Help system

### Phase 3: Polish (Week 5-6)
- [ ] Confirmation flows
- [ ] Undo system
- [ ] Table/progress renderers
- [ ] Accessibility audit

### Phase 4: Integration (Week 7-8)
- [ ] GUI discoverability hints
- [ ] All entity commands wired
- [ ] Performance optimization
- [ ] Testing

---

## Appendix A: Entity Icons

```typescript
export const ENTITY_ICONS = {
  company: 'üè¢',
  user: 'üë§',
  customer: 'üë§',
  vendor: 'üè™',
  invoice: 'üìÑ',
  payment: 'üí∞',
  bill: 'üìã',
  expense: 'üí≥',
  account: 'üè¶',
  report: 'üìä',
} as const
```

## Appendix B: Example Commands

```bash
# Invoices
invoice.list                          # All invoices
invoice.list --unpaid                 # Unpaid only
invoice.create acme 1500              # Quick create
invoice.create -c "Acme Corp" -a 1500 --due="net 30"
invoice.send 1042                     # Email invoice
invoice.void 1042                     # Void (requires confirm)

# Shortcuts
inv                                   # ‚Üí invoice.list
inv --unpaid                          # ‚Üí invoice.list --unpaid
inv new acme 1500                     # ‚Üí invoice.create acme 1500

# Payments
payment.create 1042 1500              # Pay invoice 1042
pay 1042 1500 --method=bank           # Shorthand

# Reports
report.aging                          # AR aging
report.profit-loss --period=month     # P&L
report.balance-sheet --as-of=dec31    # Balance sheet
```

---

## 16. Laravel Backend Integration

### 16.1 Command Bus Architecture

Single endpoint. Config-based routing. No magic.

**Route:**

```php
// routes/api.php

// Commands use header-based company context (X-Company-Slug)
// identify.company middleware sets context from header if present
Route::post('/commands', \App\Http\Controllers\CommandController::class)
    ->middleware(['auth', 'identify.company', 'throttle:commands']);

// Catalog endpoints also need company context
Route::middleware(['auth', 'identify.company', 'throttle:catalog'])->prefix('palette')->group(function () {
    Route::get('/customers', [PaletteCatalogController::class, 'customers']);
    Route::get('/vendors', [PaletteCatalogController::class, 'vendors']);
    Route::get('/accounts', [PaletteCatalogController::class, 'accounts']);
    Route::get('/invoices/recent', [PaletteCatalogController::class, 'recentInvoices']);
});

// app/Providers/RouteServiceProvider.php
RateLimiter::for('commands', fn($request) => Limit::perMinute(120)->by($request->user()->id));
RateLimiter::for('catalog', fn($request) => Limit::perMinute(300)->by($request->user()->id));
```

> **Note:** The `identify.company` middleware reads `X-Company-Slug` header and calls
> `CurrentCompany::setBySlug()`. If your middleware only reads from URL params,
> extend it to also check headers:
>
> ```php
> // In IdentifyCompanyMiddleware::handle()
> $slug = $request->route('company')
>     ?? $request->header('X-Company-Slug');
> ```

**Routing Config:**

```php
// config/command-bus.php
return [
    // entity.verb => Action class

    // Company (Core module)
    'company.create'     => \App\Modules\Core\Actions\Company\CreateAction::class,
    'company.list'       => \App\Modules\Core\Actions\Company\IndexAction::class,
    'company.view'       => \App\Modules\Core\Actions\Company\ShowAction::class,
    'company.switch'     => \App\Modules\Core\Actions\Company\SwitchAction::class,

    // Customer
    'customer.create'    => \App\Modules\Accounting\Actions\Customer\CreateAction::class,
    'customer.list'      => \App\Modules\Accounting\Actions\Customer\IndexAction::class,
    'customer.view'      => \App\Modules\Accounting\Actions\Customer\ShowAction::class,
    'customer.update'    => \App\Modules\Accounting\Actions\Customer\UpdateAction::class,
    'customer.delete'    => \App\Modules\Accounting\Actions\Customer\DeleteAction::class,

    // Vendor
    'vendor.create'      => \App\Modules\Accounting\Actions\Vendor\CreateAction::class,
    'vendor.list'        => \App\Modules\Accounting\Actions\Vendor\IndexAction::class,
    'vendor.view'        => \App\Modules\Accounting\Actions\Vendor\ShowAction::class,

    // Invoice
    'invoice.create'     => \App\Modules\Accounting\Actions\Invoice\CreateAction::class,
    'invoice.list'       => \App\Modules\Accounting\Actions\Invoice\IndexAction::class,
    'invoice.view'       => \App\Modules\Accounting\Actions\Invoice\ShowAction::class,
    'invoice.send'       => \App\Modules\Accounting\Actions\Invoice\SendAction::class,
    'invoice.void'       => \App\Modules\Accounting\Actions\Invoice\VoidAction::class,

    // Payment
    'payment.create'     => \App\Modules\Accounting\Actions\Payment\CreateAction::class,
    'payment.list'       => \App\Modules\Accounting\Actions\Payment\IndexAction::class,
    'payment.view'       => \App\Modules\Accounting\Actions\Payment\ShowAction::class,
    'payment.void'       => \App\Modules\Accounting\Actions\Payment\VoidAction::class,

    // Bill
    'bill.create'        => \App\Modules\Accounting\Actions\Bill\CreateAction::class,
    'bill.list'          => \App\Modules\Accounting\Actions\Bill\IndexAction::class,
    'bill.pay'           => \App\Modules\Accounting\Actions\Bill\PayAction::class,
    'bill.void'          => \App\Modules\Accounting\Actions\Bill\VoidAction::class,

    // Expense
    'expense.create'     => \App\Modules\Accounting\Actions\Expense\CreateAction::class,
    'expense.list'       => \App\Modules\Accounting\Actions\Expense\IndexAction::class,

    // Reports
    'report.aging'       => \App\Modules\Accounting\Actions\Report\AgingAction::class,
    'report.profit-loss' => \App\Modules\Accounting\Actions\Report\ProfitLossAction::class,
    'report.balance-sheet' => \App\Modules\Accounting\Actions\Report\BalanceSheetAction::class,
];
```

### 16.2 Action Contract

All palette actions implement this interface:

```php
// app/Contracts/PaletteAction.php

namespace App\Contracts;

interface PaletteAction
{
    /**
     * Execute the action.
     *
     * @param array $params Validated parameters from palette
     * @return array Response with 'message', 'data', 'redirect', 'undo' keys
     * @throws \Illuminate\Validation\ValidationException
     * @throws \Illuminate\Auth\Access\AuthorizationException
     */
    public function handle(array $params): array;

    /**
     * Validation rules for this action.
     */
    public function rules(): array;

    /**
     * Permission required (null = no check).
     */
    public function permission(): ?string;
}
```

### 16.3 Command Controller

```php
// app/Http/Controllers/CommandController.php

namespace App\Http\Controllers;

use App\Contracts\PaletteAction;
use App\Services\CurrentCompany;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Gate;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;

class CommandController extends Controller
{
    public function __invoke(Request $request): JsonResponse
    {
        // 1. Extract action from header
        $action = $request->header('X-Action');

        if (!$action || !preg_match('/^[a-z]+\.[a-z-]+$/', $action)) {
            return $this->error('BAD_REQUEST', 'Invalid or missing X-Action header', 400);
        }

        // 2. Resolve Action class
        $actionClass = config("command-bus.{$action}");

        if (!$actionClass || !class_exists($actionClass)) {
            return $this->error('NOT_FOUND', "Unknown command: {$action}", 404);
        }

        // 3. Verify company context (set by identify.company middleware)
        //    Middleware reads X-Company-Slug header and calls setBySlug()
        $currentCompany = app(CurrentCompany::class);
        $company = $currentCompany->get();

        if (!$company) {
            return $this->error('BAD_REQUEST', 'Company context required. Set X-Company-Slug header.', 400);
        }

        // 4. Check idempotency (skip for queries)
        $idemKey = $request->header('X-Idempotency-Key');
        $isQuery = str_ends_with($action, '.list') ||
                   str_ends_with($action, '.view') ||
                   str_starts_with($action, 'report.');

        if ($idemKey && !$isQuery) {
            $previous = $this->checkIdempotency($idemKey);
            if ($previous) {
                return response()->json([
                    'ok' => true,
                    'replayed' => true,
                    ...$previous,
                ], 200);
            }
        }

        // 5. Instantiate and execute action
        try {
            /** @var PaletteAction $actionInstance */
            $actionInstance = app($actionClass);
            $params = $request->input('params', []);

            // Validate
            if ($rules = $actionInstance->rules()) {
                $params = Validator::make($params, $rules)->validate();
            }

            // Authorize
            if ($permission = $actionInstance->permission()) {
                if (!$request->user()->hasCompanyPermission($permission)) {
                    throw new \Illuminate\Auth\Access\AuthorizationException(
                        "Permission denied: {$permission}"
                    );
                }
            }

            // Execute
            $result = $actionInstance->handle($params);

            // 6. Store idempotency record (mutations only)
            if ($idemKey && !$isQuery) {
                $this->storeIdempotency($idemKey, $result);
            }

            // 7. Return formatted response
            return $this->formatResponse($result, $action);

        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'ok' => false,
                'code' => 'VALIDATION',
                'message' => 'Validation failed',
                'errors' => $e->errors(),
            ], 422);

        } catch (\Illuminate\Auth\Access\AuthorizationException $e) {
            return response()->json([
                'ok' => false,
                'code' => 'FORBIDDEN',
                'message' => $e->getMessage(),
            ], 403);

        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'ok' => false,
                'code' => 'NOT_FOUND',
                'message' => 'Record not found',
            ], 404);

        } catch (\Exception $e) {
            Log::error("Command execution failed: {$action}", [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'params' => $request->input('params'),
                'user' => $request->user()?->id,
                'company' => $company->id,
            ]);

            return $this->error(
                'SERVER_ERROR',
                app()->environment('production') ? 'An error occurred' : $e->getMessage(),
                500
            );
        }
    }

    private function formatResponse(array $result, string $action): JsonResponse
    {
        $isQuery = str_ends_with($action, '.list') ||
                   str_ends_with($action, '.view') ||
                   str_starts_with($action, 'report.');

        if ($isQuery) {
            return response()->json([
                'ok' => true,
                'data' => $result['data'] ?? $result,
                'meta' => $result['meta'] ?? null,
            ], 200);
        }

        return response()->json([
            'ok' => true,
            'message' => $result['message'] ?? 'Success',
            'data' => $result['data'] ?? null,
            'redirect' => $result['redirect'] ?? null,
            'undo' => $result['undo'] ?? null,
        ], 201);
    }

    private function checkIdempotency(string $key): ?array
    {
        $record = DB::table('command_idempotency')
            ->where('key', hash('sha256', $key))
            ->where('created_at', '>', now()->subHours(24))
            ->first();

        return $record ? json_decode($record->result, true) : null;
    }

    private function storeIdempotency(string $key, array $result): void
    {
        DB::table('command_idempotency')->updateOrInsert(
            ['key' => hash('sha256', $key)],
            [
                'result' => json_encode($result),
                'created_at' => now(),
            ]
        );
    }

    private function error(string $code, string $message, int $status): JsonResponse
    {
        return response()->json([
            'ok' => false,
            'code' => $code,
            'message' => $message,
        ], $status);
    }
}
```

### 16.4 Idempotency Migration

```php
// database/migrations/xxxx_create_command_idempotency_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('command_idempotency', function (Blueprint $table) {
            $table->string('key', 64)->primary();  // SHA256 hash
            $table->jsonb('result');
            $table->timestamp('created_at');

            $table->index('created_at');  // For cleanup job
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('command_idempotency');
    }
};
```

### 16.5 Idempotency Cleanup Job

```php
// app/Console/Commands/CleanupIdempotencyCommand.php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;

class CleanupIdempotencyCommand extends Command
{
    protected $signature = 'palette:cleanup-idempotency';
    protected $description = 'Remove expired idempotency records';

    public function handle(): int
    {
        $deleted = DB::table('command_idempotency')
            ->where('created_at', '<', now()->subHours(24))
            ->delete();

        $this->info("Deleted {$deleted} expired idempotency records");

        return self::SUCCESS;
    }
}

// app/Console/Kernel.php
$schedule->command('palette:cleanup-idempotency')->dailyAt('03:00');
```

### 16.6 PostgreSQL Extensions Migration

```php
// database/migrations/xxxx_add_pg_trgm_extension.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    public function up(): void
    {
        // Required for fuzzy text matching (similarity function)
        DB::statement('CREATE EXTENSION IF NOT EXISTS pg_trgm');
    }

    public function down(): void
    {
        DB::statement('DROP EXTENSION IF EXISTS pg_trgm');
    }
};
```

### 16.7 Example Action: Invoice Create

```php
// modules/Accounting/Actions/Invoice/CreateAction.php

namespace App\Modules\Accounting\Actions\Invoice;

use App\Contracts\PaletteAction;
use App\Constants\Permissions;  // Per CLAUDE.md conventions
use App\Modules\Accounting\Models\Customer;
use App\Modules\Accounting\Models\Invoice;
use App\Services\CurrentCompany;
use App\Support\PaletteFormatter;
use Illuminate\Support\Facades\DB;

class CreateAction implements PaletteAction
{
    public function rules(): array
    {
        return [
            'customer' => 'required|string|max:255',
            'amount' => 'required|numeric|min:0.01|max:999999999.99',
            'due' => 'nullable|date|after_or_equal:today',
            'notes' => 'nullable|string|max:1000',
            'draft' => 'nullable|boolean',
        ];
    }

    public function permission(): ?string
    {
        return Permissions::INVOICE_CREATE;
    }

    public function handle(array $params): array
    {
        $company = app(CurrentCompany::class)->get();

        // Resolve customer (by ID or fuzzy name match)
        $customer = $this->resolveCustomer($params['customer'], $company);

        if (!$customer) {
            throw new \InvalidArgumentException(
                "Customer not found: {$params['customer']}"
            );
        }

        // Create invoice in transaction
        $invoice = DB::transaction(function () use ($params, $customer, $company) {
            $invoice = Invoice::create([
                'company_id' => $company->id,
                'customer_id' => $customer->id,
                'amount' => $params['amount'],
                'due_date' => $params['due'] ?? now()->addDays($company->default_payment_terms ?? 30),
                'status' => ($params['draft'] ?? false) ? 'draft' : 'pending',
                'notes' => $params['notes'] ?? null,
            ]);

            // Post to GL unless draft
            if ($invoice->status !== 'draft') {
                $this->postToLedger($invoice);
            }

            return $invoice;
        });

        return [
            'message' => "Invoice {$invoice->number} created for {$customer->name}",
            'data' => [
                'id' => $invoice->id,
                'number' => $invoice->number,
                'amount' => PaletteFormatter::money($invoice->amount, $company->currency),
                'customer' => $customer->name,
                'status' => $invoice->status,
            ],
            'redirect' => "/{$company->slug}/invoices/{$invoice->id}",
            'undo' => [
                'action' => 'invoice.void',
                'params' => ['id' => $invoice->id],
                'expiresAt' => now()->addSeconds(10)->timestamp,
            ],
        ];
    }

    private function resolveCustomer(string $identifier, $company): ?Customer
    {
        // Try exact ID match first
        if (is_numeric($identifier)) {
            return Customer::where('company_id', $company->id)
                ->find((int) $identifier);
        }

        // Try exact name match
        $exact = Customer::where('company_id', $company->id)
            ->whereRaw('LOWER(name) = ?', [strtolower($identifier)])
            ->first();

        if ($exact) {
            return $exact;
        }

        // Fuzzy match using pg_trgm (requires extension)
        return Customer::where('company_id', $company->id)
            ->whereRaw('similarity(name, ?) > 0.3', [$identifier])
            ->orderByRaw('similarity(name, ?) DESC', [$identifier])
            ->first();
    }

    private function postToLedger(Invoice $invoice): void
    {
        // Your existing GL posting logic
        // Debit: Accounts Receivable
        // Credit: Revenue
    }
}
```

### 16.8 Example Action: Invoice List

```php
// modules/Accounting/Actions/Invoice/IndexAction.php

namespace App\Modules\Accounting\Actions\Invoice;

use App\Contracts\PaletteAction;
use App\Constants\Permissions;  // Per CLAUDE.md conventions
use App\Modules\Accounting\Models\Customer;
use App\Modules\Accounting\Models\Invoice;
use App\Services\CurrentCompany;
use App\Support\PaletteFormatter;

class IndexAction implements PaletteAction
{
    public function rules(): array
    {
        return [
            'customer' => 'nullable|string|max:255',
            'status' => 'nullable|string|in:draft,pending,sent,paid,overdue,void',
            'unpaid' => 'nullable|boolean',
            'overdue' => 'nullable|boolean',
            'from' => 'nullable|date',
            'to' => 'nullable|date|after_or_equal:from',
            'limit' => 'nullable|integer|min:1|max:100',
        ];
    }

    public function permission(): ?string
    {
        return Permissions::INVOICE_VIEW;
    }

    public function handle(array $params): array
    {
        $company = app(CurrentCompany::class)->get();
        $limit = $params['limit'] ?? 50;

        $query = Invoice::where('company_id', $company->id)
            ->with('customer:id,name');

        // Status filters
        if ($params['unpaid'] ?? false) {
            $query->whereIn('status', ['pending', 'sent', 'overdue']);
        } elseif ($params['overdue'] ?? false) {
            $query->where('status', 'overdue');
        } elseif (isset($params['status'])) {
            $query->where('status', $params['status']);
        }

        // Customer filter
        if (isset($params['customer'])) {
            $customer = $this->resolveCustomer($params['customer'], $company);
            if ($customer) {
                $query->where('customer_id', $customer->id);
            }
        }

        // Date range
        if (isset($params['from'])) {
            $query->whereDate('created_at', '>=', $params['from']);
        }
        if (isset($params['to'])) {
            $query->whereDate('created_at', '<=', $params['to']);
        }

        $invoices = $query
            ->orderBy('created_at', 'desc')
            ->limit($limit)
            ->get();

        // Format as palette table
        return [
            'data' => PaletteFormatter::table(
                headers: ['INV#', 'Customer', 'Amount', 'Due', 'Status'],
                rows: $invoices->map(fn($inv) => [
                    $inv->number,
                    $inv->customer->name,
                    PaletteFormatter::money($inv->amount, $company->currency),
                    $inv->due_date->format('M j'),
                    PaletteFormatter::status($inv->status),
                ])->toArray(),
                footer: $this->buildFooter($invoices, $company)
            ),
            'meta' => [
                'total' => $invoices->count(),
                'sum' => $invoices->sum('amount'),
            ],
        ];
    }

    private function resolveCustomer(string $identifier, $company): ?Customer
    {
        if (is_numeric($identifier)) {
            return Customer::where('company_id', $company->id)->find((int) $identifier);
        }

        return Customer::where('company_id', $company->id)
            ->whereRaw('similarity(name, ?) > 0.3', [$identifier])
            ->orderByRaw('similarity(name, ?) DESC', [$identifier])
            ->first();
    }

    private function buildFooter($invoices, $company): string
    {
        $count = $invoices->count();
        $sum = PaletteFormatter::money($invoices->sum('amount'), $company->currency);
        return "{$count} invoice" . ($count !== 1 ? 's' : '') . " ¬∑ {$sum} total";
    }
}
```

### 16.9 Palette Formatter Helper

```php
// app/Support/PaletteFormatter.php

namespace App\Support;

use App\Services\CurrentCompany;
use NumberFormatter;

class PaletteFormatter
{
    /**
     * Format data as table for palette renderer.
     */
    public static function table(array $headers, array $rows, ?string $footer = null): array
    {
        return [
            'type' => 'table',
            'headers' => $headers,
            'rows' => $rows,
            'footer' => $footer,
        ];
    }

    /**
     * Format money using company locale/currency.
     */
    public static function money(float $amount, ?string $currency = null): string
    {
        $currency = $currency ?? app(CurrentCompany::class)->get()?->currency ?? 'USD';
        $locale = app(CurrentCompany::class)->get()?->locale ?? 'en_US';

        $formatter = new NumberFormatter($locale, NumberFormatter::CURRENCY);
        return $formatter->formatCurrency($amount, $currency);
    }

    /**
     * Format status with semantic color tag and icon.
     */
    public static function status(string $status): string
    {
        return match ($status) {
            'paid' => '{success}‚óè Paid{/}',
            'pending' => '{warning}‚óê Pending{/}',
            'sent' => '{accent}‚óë Sent{/}',
            'overdue' => '{error}‚ö† Overdue{/}',
            'draft' => '{secondary}‚óã Draft{/}',
            'void' => '{secondary}‚äò Void{/}',
            default => $status,
        };
    }

    /**
     * Format date relative to today.
     */
    public static function relativeDate(\DateTimeInterface $date): string
    {
        $diff = now()->diffInDays($date, false);

        return match (true) {
            $diff === 0 => 'Today',
            $diff === 1 => 'Tomorrow',
            $diff === -1 => 'Yesterday',
            $diff > 0 && $diff <= 7 => "In {$diff} days",
            $diff < 0 && $diff >= -7 => abs($diff) . ' days ago',
            default => $date->format('M j'),
        };
    }

    /**
     * Success message with icon.
     */
    public static function success(string $message): string
    {
        return "{success}‚úì{/} {$message}";
    }

    /**
     * Error message with icon.
     */
    public static function error(string $message): string
    {
        return "{error}‚úó{/} {$message}";
    }

    /**
     * Warning message with icon.
     */
    public static function warning(string $message): string
    {
        return "{warning}‚ö†{/} {$message}";
    }
}
```

### 16.10 Company Context Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          Frontend (Vue)                                  ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  1. User types: inv new acme 1500                                       ‚îÇ
‚îÇ  2. Parser extracts: entity=invoice, verb=create, flags={customer,amt}  ‚îÇ
‚îÇ  3. Company slug from URL: /{company}/dashboard ‚Üí "acme-corp"           ‚îÇ
‚îÇ  4. Generate idempotency key: SHA256(user + action + params + timestamp)‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  POST /api/commands                                                     ‚îÇ
‚îÇ  Headers:                                                               ‚îÇ
‚îÇ    X-Action: invoice.create                                             ‚îÇ
‚îÇ    X-Company-Slug: acme-corp                                            ‚îÇ
‚îÇ    X-Idempotency-Key: a1b2c3d4...                                       ‚îÇ
‚îÇ  Body:                                                                  ‚îÇ
‚îÇ    { "params": { "customer": "acme", "amount": 1500 } }                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        Laravel Backend                                   ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  1. CommandController receives request                                  ‚îÇ
‚îÇ  2. Validates X-Action header format                                    ‚îÇ
‚îÇ  3. Sets company: CurrentCompany::setBySlug('acme-corp')                ‚îÇ
‚îÇ  4. Checks idempotency table (skip if replay)                           ‚îÇ
‚îÇ  5. Resolves: config('command-bus.invoice.create') ‚Üí CreateAction       ‚îÇ
‚îÇ  6. Validates params against CreateAction::rules()                      ‚îÇ
‚îÇ  7. Checks permission: CreateAction::permission()                       ‚îÇ
‚îÇ  8. Executes: CreateAction::handle($params)                             ‚îÇ
‚îÇ  9. Stores idempotency record                                           ‚îÇ
‚îÇ  10. Returns formatted JSON                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       Response to Frontend                               ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  {                                                                      ‚îÇ
‚îÇ    "ok": true,                                                          ‚îÇ
‚îÇ    "message": "Invoice INV-001 created for Acme Corp",                  ‚îÇ
‚îÇ    "data": {                                                            ‚îÇ
‚îÇ      "id": 42,                                                          ‚îÇ
‚îÇ      "number": "INV-001",                                               ‚îÇ
‚îÇ      "amount": "$1,500.00",                                             ‚îÇ
‚îÇ      "customer": "Acme Corp"                                            ‚îÇ
‚îÇ    },                                                                   ‚îÇ
‚îÇ    "redirect": "/acme-corp/invoices/42",                                ‚îÇ
‚îÇ    "undo": {                                                            ‚îÇ
‚îÇ      "action": "invoice.void",                                          ‚îÇ
‚îÇ      "params": { "id": 42 },                                            ‚îÇ
‚îÇ      "expiresAt": 1704067210                                            ‚îÇ
‚îÇ    }                                                                    ‚îÇ
‚îÇ  }                                                                      ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  Palette renders:                                                       ‚îÇ
‚îÇ  ‚úì Invoice INV-001 created for Acme Corp ($1,500.00)                    ‚îÇ
‚îÇ  ‚Üí Open in GUI                                                          ‚îÇ
‚îÇ  [Undo - 10s]                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 17. Autocomplete Data Sources

### 17.1 Catalog Controller

```php
// app/Http/Controllers/PaletteCatalogController.php

namespace App\Http\Controllers;

use App\Modules\Accounting\Models\Account;
use App\Modules\Accounting\Models\Customer;
use App\Modules\Accounting\Models\Invoice;
use App\Modules\Accounting\Models\Vendor;
use App\Services\CurrentCompany;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class PaletteCatalogController extends Controller
{
    private const MAX_RESULTS = 500;
    private const SEARCH_LIMIT = 50;

    public function customers(Request $request): JsonResponse
    {
        $company = app(CurrentCompany::class)->get();
        $search = $request->query('q');

        $query = Customer::where('company_id', $company->id)
            ->select('id', 'name', 'email')
            ->selectRaw('COALESCE(balance_outstanding, 0) as outstanding');

        if ($search) {
            $query->where(function ($q) use ($search) {
                $q->whereRaw('name ILIKE ?', ["%{$search}%"])
                  ->orWhereRaw('email ILIKE ?', ["%{$search}%"]);
            })->limit(self::SEARCH_LIMIT);
        } else {
            $query->orderBy('name')->limit(self::MAX_RESULTS);
        }

        $customers = $query->get()->map(fn($c) => [
            'id' => $c->id,
            'name' => $c->name,
            'searchText' => strtolower("{$c->name} {$c->email}"),
            'meta' => $c->outstanding > 0
                ? ['outstanding' => PaletteFormatter::money($c->outstanding)]
                : null,
        ]);

        return response()->json($customers)
            ->header('Cache-Control', 'private, max-age=300');  // 5 min
    }

    public function vendors(Request $request): JsonResponse
    {
        $company = app(CurrentCompany::class)->get();
        $search = $request->query('q');

        $query = Vendor::where('company_id', $company->id)
            ->select('id', 'name', 'email');

        if ($search) {
            $query->where(function ($q) use ($search) {
                $q->whereRaw('name ILIKE ?', ["%{$search}%"])
                  ->orWhereRaw('email ILIKE ?', ["%{$search}%"]);
            })->limit(self::SEARCH_LIMIT);
        } else {
            $query->orderBy('name')->limit(self::MAX_RESULTS);
        }

        $vendors = $query->get()->map(fn($v) => [
            'id' => $v->id,
            'name' => $v->name,
            'searchText' => strtolower("{$v->name} {$v->email}"),
        ]);

        return response()->json($vendors)
            ->header('Cache-Control', 'private, max-age=300');
    }

    public function accounts(): JsonResponse
    {
        $company = app(CurrentCompany::class)->get();

        $accounts = Account::where('company_id', $company->id)
            ->select('id', 'code', 'name', 'type')
            ->orderBy('code')
            ->limit(self::MAX_RESULTS)
            ->get()
            ->map(fn($a) => [
                'id' => $a->id,
                'name' => "{$a->code} - {$a->name}",
                'searchText' => strtolower("{$a->code} {$a->name}"),
                'meta' => ['type' => $a->type],
            ]);

        return response()->json($accounts)
            ->header('Cache-Control', 'private, max-age=600');  // 10 min
    }

    public function recentInvoices(): JsonResponse
    {
        $company = app(CurrentCompany::class)->get();

        $invoices = Invoice::where('company_id', $company->id)
            ->with('customer:id,name')
            ->whereIn('status', ['pending', 'sent', 'overdue'])  // Active only
            ->orderBy('created_at', 'desc')
            ->limit(100)
            ->get()
            ->map(fn($i) => [
                'id' => $i->id,
                'number' => $i->number,
                'searchText' => strtolower("{$i->number} {$i->customer->name}"),
                'meta' => [
                    'customer' => $i->customer->name,
                    'amount' => PaletteFormatter::money($i->amount),
                    'status' => $i->status,
                ],
            ]);

        return response()->json($invoices)
            ->header('Cache-Control', 'private, max-age=60');  // 1 min
    }
}
```

### 17.2 Frontend Catalog Composable

```typescript
// composables/useEntityCatalogs.ts

import { ref, onMounted } from 'vue'

interface CatalogEntity {
  id: number | string
  name: string
  searchText: string
  meta?: Record<string, unknown>
}

export function useEntityCatalogs() {
  const customers = ref<CatalogEntity[]>([])
  const vendors = ref<CatalogEntity[]>([])
  const accounts = ref<CatalogEntity[]>([])
  const recentInvoices = ref<CatalogEntity[]>([])
  const loading = ref(false)
  const error = ref<string | null>(null)

  async function load() {
    loading.value = true
    error.value = null

    try {
      const [c, v, a, i] = await Promise.all([
        fetch('/api/palette/customers').then(r => r.ok ? r.json() : []),
        fetch('/api/palette/vendors').then(r => r.ok ? r.json() : []),
        fetch('/api/palette/accounts').then(r => r.ok ? r.json() : []),
        fetch('/api/palette/invoices/recent').then(r => r.ok ? r.json() : []),
      ])

      customers.value = c
      vendors.value = v
      accounts.value = a
      recentInvoices.value = i
    } catch (e) {
      error.value = 'Failed to load catalogs'
      console.error('Catalog load failed:', e)
    } finally {
      loading.value = false
    }
  }

  // Search with server-side filtering (for large datasets)
  async function searchCustomers(query: string): Promise<CatalogEntity[]> {
    if (!query || query.length < 2) return customers.value.slice(0, 10)

    const response = await fetch(`/api/palette/customers?q=${encodeURIComponent(query)}`)
    return response.ok ? response.json() : []
  }

  async function searchVendors(query: string): Promise<CatalogEntity[]> {
    if (!query || query.length < 2) return vendors.value.slice(0, 10)

    const response = await fetch(`/api/palette/vendors?q=${encodeURIComponent(query)}`)
    return response.ok ? response.json() : []
  }

  onMounted(() => load())

  return {
    customers,
    vendors,
    accounts,
    recentInvoices,
    loading,
    error,
    reload: load,
    searchCustomers,
    searchVendors,
  }
}
```

### 17.3 Module Structure

```
app/
‚îú‚îÄ‚îÄ Contracts/
‚îÇ   ‚îî‚îÄ‚îÄ PaletteAction.php              # Action interface
‚îú‚îÄ‚îÄ Http/Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ CommandController.php          # Single command endpoint
‚îÇ   ‚îî‚îÄ‚îÄ PaletteCatalogController.php   # Entity catalogs
‚îú‚îÄ‚îÄ Support/
‚îÇ   ‚îî‚îÄ‚îÄ PaletteFormatter.php           # Response formatting
‚îî‚îÄ‚îÄ Console/Commands/
    ‚îî‚îÄ‚îÄ CleanupIdempotencyCommand.php  # Daily cleanup

config/
‚îî‚îÄ‚îÄ command-bus.php                    # Action routing map

modules/
‚îú‚îÄ‚îÄ Accounting/
‚îÇ   ‚îú‚îÄ‚îÄ Actions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Invoice/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IndexAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ShowAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SendAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VoidAction.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Payment/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IndexAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VoidAction.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Customer/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IndexAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UpdateAction.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Vendor/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IndexAction.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Bill/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IndexAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PayAction.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Expense/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAction.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IndexAction.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Report/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AgingAction.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ProfitLossAction.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ BalanceSheetAction.php
‚îÇ   ‚îî‚îÄ‚îÄ Models/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ Core/
    ‚îî‚îÄ‚îÄ Actions/
        ‚îî‚îÄ‚îÄ Company/
            ‚îú‚îÄ‚îÄ CreateAction.php
            ‚îú‚îÄ‚îÄ IndexAction.php
            ‚îú‚îÄ‚îÄ SwitchAction.php
            ‚îî‚îÄ‚îÄ ShowAction.php

database/migrations/
‚îú‚îÄ‚îÄ xxxx_create_command_idempotency_table.php
‚îî‚îÄ‚îÄ xxxx_add_pg_trgm_extension.php
```

---

*Document version: 3.3 (Final)*
*Stack: Custom Vue 3, no external terminal libraries*
*Theming: Posting.sh-inspired 7-color semantic system (galaxy, monokai, nord, dracula)*
*Backend: Laravel command bus pattern with Action classes*


===== cli-specs.md =====
# Haasib Command System ‚Äî Unified Specification v2

> **Philosophy**: The command palette is Robin to the GUI's Batman. It accelerates power users while gently teaching novices. Every keystroke should feel intentional, every response immediate.

---

## Design Decisions (Settled)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Locale** | Configurable per company | Date format (DD/MM vs MM/DD), number format (1,000.00 vs 1.000,00) |
| **Currency** | Multi-currency per company | Each company can have base currency + transaction currencies |
| **Offline/Network failure** | Toast notification + retry queue | "Connection lost. Command queued. Will retry when online." |
| **Mobile support** | No | Palette is desktop-only. Mobile users get GUI only. Hide Cmd+K hints on touch devices. |
| **Terminal library** | jQuery Terminal | Purpose-built for command interpreters, not real shell access. Batteries included: autocomplete, history, formatting. |
| **Palette architecture** | Hybrid | Collapsed: lightweight Vue input. Expanded: jQuery Terminal for full experience. Both share same parser/API. |

---

## Table of Contents

1. [Design Principles](#1-design-principles)
2. [Architecture Overview](#2-architecture-overview)
3. [Grammar Specification](#3-grammar-specification)
4. [MVP Scope & Phases](#4-mvp-scope--phases)
5. [Discoverability System](#5-discoverability-system)
6. [Parser & Autocomplete](#6-parser--autocomplete)
7. [Inline Help System](#7-inline-help-system)
8. [Undo & Confirmation](#8-undo--confirmation)
9. [Onboarding Strategy](#9-onboarding-strategy)
10. [UI/UX Specification](#10-uiux-specification)
11. [Backend Contract](#11-backend-contract)
12. [Performance Targets](#12-performance-targets)
13. [Testing Strategy](#13-testing-strategy)
14. [Rollout Milestones](#14-rollout-milestones)
15. [Command Reference](#15-command-reference)

---

## 1. Design Principles

### 1.1 Non-Negotiables

| Principle | Rationale |
|-----------|-----------|
| **GUI parity** | Every GUI feature reachable from palette. No hidden functionality. |
| **One grammar** | Single, learnable pattern. No exceptions. |
| **Forgiveness over precision** | Multiple inputs ‚Üí same outcome. Never punish typos. |
| **Show, don't lecture** | Inline hints, not documentation walls. |
| **Speed is UX** | < 60ms to suggestions, < 300ms to commit. Non-negotiable. |
| **Safe by default** | Destructive actions require confirmation. Always. |

### 1.2 User Mental Model

```
"I type what I want. It figures out the rest."
```

The user should never:
- Memorize exact flag names
- Wonder if their input was understood
- Fear making mistakes
- Feel slower than clicking

### 1.3 The Addiction Formula

```
Discoverability ‚Üí First Success ‚Üí Habit Formation ‚Üí Preference
      ‚Üì                ‚Üì               ‚Üì                ‚Üì
  GUI hints      Instant result    History/TAB     Time savings
```

Users don't become "addicted" by seeing the palette. They become addicted through:
1. **Accidental discovery** via GUI hints
2. **Immediate reward** from faster completion
3. **Muscle memory** from consistent grammar
4. **Social proof** from seeing others use it

---

## 2. Architecture Overview

### 2.1 Two Interfaces, One Brain

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        HAASIB APP                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ   ‚îÇ     GUI      ‚îÇ              ‚îÇ   Command    ‚îÇ                ‚îÇ
‚îÇ   ‚îÇ   (Vue/      ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Palette    ‚îÇ                ‚îÇ
‚îÇ   ‚îÇ   Inertia)   ‚îÇ   bidirectional  (xterm.js) ‚îÇ                ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ          ‚îÇ                             ‚îÇ                         ‚îÇ
‚îÇ          ‚îÇ         Same Services       ‚îÇ                         ‚îÇ
‚îÇ          ‚ñº                             ‚ñº                         ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ   ‚îÇ              Command Bus                     ‚îÇ               ‚îÇ
‚îÇ   ‚îÇ   (Laravel Actions + Policies + Tenancy)    ‚îÇ               ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                          ‚îÇ                                       ‚îÇ
‚îÇ                          ‚ñº                                       ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ   ‚îÇ              PostgreSQL                      ‚îÇ               ‚îÇ
‚îÇ   ‚îÇ         (Multi-tenant Data)                 ‚îÇ               ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 Palette Placement

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üè¢ Acme Corp          Dashboard          yasir@acme.com    ‚öôÔ∏è  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ                      [ Main GUI Content ]                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ùØ invoice.create acme 1500                    [‚ñ≠] [‚Äî] [‚õ∂]      ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ invoice.create  Create new invoice                      ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ invoice.list    List invoices [--unpaid] [--overdue]    ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ invoice.send    Email invoice to customer               ‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Legend:
[‚ñ≠] = Expand to half-screen
[‚Äî] = Collapse to thin strip
[‚õ∂] = Fullscreen mode
```

### 2.3 Progressive Scaffold (current)

- Schema-driven scaffolds for revenue commands (`invoice`, `payment`, `customer`, `company`) render skeleton + pointer + status below the input.
- Flag chips show defaults with source labels (company/customer currency, invoice balance, payment terms) and insert flag stubs; status line tracks remaining required args.
- Parser infers positional args for invoice/payment (customer/invoice, amount, currency) to reduce flag typing.
- Field-aware suggestions target the active arg (customers, invoices, currencies) via palette catalogs; placeholder hints appear when no dropdown results.
- Extendable: add schemas in `palette/schemas.ts`; scaffold auto-renders for new commands as schemas are registered.

### 2.3 State Persistence

| State | Storage | Lifetime |
|-------|---------|----------|
| Palette size preference | localStorage | Permanent |
| Command history | IndexedDB | 90 days |
| Recent entities | IndexedDB | 30 days |
| Favorites/pins | Server (user prefs) | Permanent |
| Templates | Server (per company) | Permanent |

---

## 3. Grammar Specification

### 3.1 Canonical Pattern

```
<entity>.<verb> [subject] [flags]
```

**This is the ONLY pattern.** Everything else is sugar that resolves to this.

### 3.2 Formal Grammar (BNF)

```bnf
<command>     ::= <entity> "." <verb> <arguments>?
                | <shortcut>
                | <natural>

<entity>      ::= "company" | "user" | "invoice" | "payment"
                | "bill" | "expense" | "customer" | "vendor"
                | "account" | "ledger" | "report"

<verb>        ::= "create" | "list" | "view" | "update" | "delete"
                | "send" | "void" | "assign" | "unassign"
                | "reconcile" | "export"

<arguments>   ::= <subject>? <flags>*

<subject>     ::= <identifier> | <quoted-string> | <number>

<flags>       ::= <long-flag> | <short-flag>
<long-flag>   ::= "--" <flag-name> ("=" <value>)?
<short-flag>  ::= "-" <letter> <value>?

<shortcut>    ::= "inv" | "pay" | "bill" | "exp" | "cust" | "vend"
                  (resolves to entity.list or contextual default)

<natural>     ::= free-form text parsed by intent classifier
```

### 3.3 Resolution Rules

User input is normalized through these steps:

```
Step 1: Shortcut expansion
  "inv"           ‚Üí "invoice.list"
  "inv new"       ‚Üí "invoice.create"
  "inv acme"      ‚Üí "invoice.list --customer=acme"

Step 2: Synonym mapping
  "create invoice" ‚Üí "invoice.create"
  "new invoice"    ‚Üí "invoice.create"
  "bill customer"  ‚Üí "invoice.create"

Step 3: Preposition extraction
  "to acme"       ‚Üí --customer=acme
  "for 1500"      ‚Üí --amount=1500
  "as admin"      ‚Üí --role=admin
  "from jan"      ‚Üí --from=jan

Step 4: Smart type inference
  "1500"          ‚Üí --amount=1500 (if verb expects amount)
  "acme"          ‚Üí --customer=acme (fuzzy match to entity)
  "jan 15"        ‚Üí --date=2025-01-15 (date parsing)
  "net 30"        ‚Üí --due=+30days

Step 5: Flag normalization
  "-c acme"       ‚Üí --customer=acme
  "-a 1500"       ‚Üí --amount=1500
  "--amt=1500"    ‚Üí --amount=1500 (alias resolution)
```

### 3.4 Entity-Verb Matrix

| Entity | create | list | view | update | delete | send | void |
|--------|--------|------|------|--------|--------|------|------|
| company | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî |
| user | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî |
| invoice | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚úì | ‚úì |
| payment | ‚úì | ‚úì | ‚úì | ‚Äî | ‚úì | ‚Äî | ‚úì |
| bill | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî | ‚úì |
| expense | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî |
| customer | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî |
| vendor | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî |
| account | ‚úì | ‚úì | ‚úì | ‚úì | ‚Äî | ‚Äî | ‚Äî |
| ledger | post | ‚úì | ‚úì | ‚Äî | ‚Äî | ‚Äî | reverse |
| report | ‚Äî | ‚úì | ‚úì | ‚Äî | ‚Äî | export | ‚Äî |

### 3.5 Universal Flags

These work across all applicable commands:

| Flag | Short | Type | Example |
|------|-------|------|---------|
| `--customer` | `-c` | string | `--customer="Acme Corp"` |
| `--vendor` | `-v` | string | `--vendor="Office Depot"` |
| `--amount` | `-a` | money | `--amount=1500` or `-a 1500$` |
| `--date` | `-d` | date | `--date=jan15` or `-d "Jan 15"` |
| `--from` | | date | `--from=2025-01-01` |
| `--to` | | date | `--to=2025-01-31` |
| `--status` | `-s` | enum | `--status=unpaid` |
| `--account` | | string | `--account="Cash"` |
| `--ref` | | string | `--ref=INV-001` |
| `--notes` | `-n` | string | `--notes="Q1 services"` |
| `--draft` | | bool | `--draft` (don't post to GL) |
| `--format` | `-f` | enum | `--format=json` or `csv` or `table` |
| `--help` | `-h` | bool | Show command help |

---

## 4. MVP Scope & Phases

### Phase 1: Foundations (Current)
**Goal**: Core infrastructure + DevOps commands

| Component | Status | Notes |
|-----------|--------|-------|
| Palette shell (expand/collapse/fullscreen) | ‚úì | |
| Hotkey binding (Cmd/Ctrl+K) | ‚úì | |
| Entity-first guided flow | ‚úì | |
| Freeform parsing | ‚úì | Basic |
| `company.create\|delete\|assign\|unassign` | ‚úì | |
| `user.create\|delete\|update` | ‚úì | |
| Idempotency | ‚úì | |
| Audit logging | ‚úì | |
| Error toasts | ‚úì | |

### Phase 2: Accounting Core (Next)
**Goal**: Invoice/Payment/Bill + Reports

| Component | Target | Dependencies |
|-----------|--------|--------------|
| `customer.create\|list\|view\|update` | Week 1 | ‚Äî |
| `vendor.create\|list\|view\|update` | Week 1 | ‚Äî |
| `invoice.create\|list\|view\|send\|void` | Week 2-3 | customer |
| `payment.create\|list\|view\|void` | Week 3 | invoice |
| `bill.create\|list\|view\|void` | Week 4 | vendor |
| `expense.create\|list\|view` | Week 4 | account |
| `report.list\|view` (AR aging, AP aging, P&L) | Week 5 | All above |
| GUI discoverability hints | Week 5 | ‚Äî |

### Phase 3: Power Features
**Goal**: Templates, history, workflows

| Component | Target |
|-----------|--------|
| Command history (‚Üë/‚Üì) | Week 6 |
| Favorites/pins | Week 6 |
| Templates (`template.save\|list\|run`) | Week 7 |
| Batch operations (`invoice.send --status=unpaid`) | Week 8 |
| Export modes (`--format=csv\|json`) | Week 8 |
| Workflows (`workflow.month-end`) | Week 9 |

### Phase 4: Intelligence
**Goal**: Natural language, learning

| Component | Target |
|-----------|--------|
| Natural language queries ("who owes me?") | Week 10 |
| Anomaly warnings | Week 11 |
| Personalized suggestions | Week 12 |

---

## 5. Discoverability System

### 5.1 GUI ‚Üí Palette Hints

Every significant GUI action should hint at its command equivalent.

**Pattern A: Post-action toast**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úì Invoice #1042 created                ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚ö° Tip: invoice.create acme 1500       ‚îÇ
‚îÇ     does this in 2 seconds              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pattern B: Button tooltip**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  + New Invoice       ‚îÇ  ‚Üê hover
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Shortcut:            ‚îÇ
‚îÇ invoice.create       ‚îÇ
‚îÇ or just: inv new     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pattern C: Empty state nudge**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                             ‚îÇ
‚îÇ              No unpaid invoices üéâ                          ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ   Pro tip: Press Cmd+K and type "inv --unpaid"              ‚îÇ
‚îÇ   to check this anytime                                     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pattern D: Keyboard shortcut badge**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Invoices                    Cmd+K inv ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Invoice list here...                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.2 Discovery Frequency Rules

| User Tenure | Hint Frequency | Types Shown |
|-------------|----------------|-------------|
| First week | Every action | All patterns |
| Week 2-4 | 1 in 3 actions | A, C only |
| Month 2+ | 1 in 10 actions | C only |
| Palette user | Never | None (they know) |

Detection: Track `palette_command_count` per user. If > 20, reduce hints.

### 5.3 Discoverability Database

Store hint mappings:

```typescript
// resources/js/discoverability/hints.ts
export const actionHints: Record<string, HintConfig> = {
  'gui.invoice.create': {
    command: 'invoice.create',
    shorthand: 'inv new',
    example: 'inv new acme 1500',
    benefit: 'Create invoices in 2 seconds'
  },
  'gui.invoice.list.unpaid': {
    command: 'invoice.list --unpaid',
    shorthand: 'inv --unpaid',
    benefit: 'Check unpaid invoices instantly'
  },
  'gui.report.aging': {
    command: 'report.aging',
    shorthand: 'aging',
    benefit: 'See who owes you in one command'
  }
}
```

---

## 6. Parser & Autocomplete

### 6.1 Parser Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Input: "inv acme 1500"                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Tokenizer                                                  ‚îÇ
‚îÇ  ["inv", "acme", "1500"]                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Shortcut Expander                                          ‚îÇ
‚îÇ  "inv" ‚Üí entity: "invoice", verb: "create" (contextual)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Entity Matcher (Fuse.js)                                   ‚îÇ
‚îÇ  "acme" ‚Üí customer: { id: 42, name: "Acme Corp" }           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Type Inferencer                                            ‚îÇ
‚îÇ  "1500" ‚Üí amount: 1500 (verb expects amount)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Output: ParsedCommand                                      ‚îÇ
‚îÇ  {                                                          ‚îÇ
‚îÇ    action: "invoice.create",                                ‚îÇ
‚îÇ    params: { customer_id: 42, amount: 1500 },               ‚îÇ
‚îÇ    missing: ["due_date"],                                   ‚îÇ
‚îÇ    confidence: 0.92,                                        ‚îÇ
‚îÇ    idemKey: "sha256:..."                                    ‚îÇ
‚îÇ  }                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.2 Forgiving Parser Rules

**Rule 1: Order doesn't matter**
```
invoice.create acme 1500
invoice.create 1500 acme
inv acme 1500$
inv 1500 to acme
```
All ‚Üí `invoice.create --customer=acme --amount=1500`

**Rule 2: Typos are corrected**
```
invocie.create  ‚Üí invoice.create (Levenshtein ‚â§ 2)
incoice.craete  ‚Üí invoice.create
inv creaet      ‚Üí invoice.create
```

**Rule 3: Synonyms are understood**
```
bill customer acme     ‚Üí invoice.create --customer=acme
send invoice to acme   ‚Üí invoice.create --customer=acme
new inv acme           ‚Üí invoice.create --customer=acme
```

**Rule 4: Amounts are flexible**
```
1500      ‚Üí 1500.00
1500$     ‚Üí 1500.00
$1,500    ‚Üí 1500.00
1.5k      ‚Üí 1500.00
1500.50   ‚Üí 1500.50
```

**Rule 5: Dates are flexible**
```
jan 15       ‚Üí 2025-01-15
jan15        ‚Üí 2025-01-15
15/1         ‚Üí 2025-01-15
15-jan       ‚Üí 2025-01-15
tomorrow     ‚Üí (computed)
next friday  ‚Üí (computed)
net 30       ‚Üí (today + 30 days)
30 days      ‚Üí (today + 30 days)
eom          ‚Üí (end of month)
```

### 6.3 Autocomplete Behavior

**Trigger**: After 1 character typed (instant)

**Ranking Algorithm**:
1. Exact prefix match (score: 1.0)
2. Recent commands (score: 0.9, decay by age)
3. Fuzzy match (score: Fuse.js score)
4. Context boost (+0.2 if related to current page)

**Visual Display**:
```
‚ùØ inv
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ invoice.create   Create new invoice           ‚è±Ô∏è recent ‚îÇ
  ‚îÇ invoice.list     List invoices                          ‚îÇ
  ‚îÇ invoice.send     Send invoice by email                  ‚îÇ
  ‚îÇ invoice.void     Void an invoice                        ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ Recent: inv acme 2500                         ‚Üµ repeat  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**After entity selected**:
```
‚ùØ invoice.create
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ Customers:                                               ‚îÇ
  ‚îÇ   acme       Acme Corp            $4,200 outstanding    ‚îÇ
  ‚îÇ   beta       Beta LLC             $0 outstanding        ‚îÇ
  ‚îÇ   gamma      Gamma Industries     $850 outstanding      ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ Type customer name or continue with flags               ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.4 TAB Completion

| Context | TAB behavior |
|---------|--------------|
| Empty input | Show recent commands |
| Partial entity | Complete entity name |
| After entity | Show available verbs |
| After verb | Complete first required param |
| Partial flag | Complete flag name |
| Multiple matches | Cycle through options |
| Single match | Insert and advance cursor |

### 6.5 Autocomplete Data Sources

```typescript
// Built in Web Worker, refreshed on focus
interface AutocompleteIndex {
  commands: CommandDef[]           // Static, from registry
  customers: LightEntity[]         // From API, cached 5min
  vendors: LightEntity[]           // From API, cached 5min
  accounts: LightEntity[]          // From API, cached 5min
  invoices: LightEntity[]          // Recent 100, cached 1min
  history: HistoryEntry[]          // From IndexedDB
}

interface LightEntity {
  id: number
  name: string
  searchText: string               // Denormalized for Fuse
  meta?: Record<string, any>       // e.g., outstanding balance
}
```

---

## 7. Inline Help System

### 7.1 Help Triggers

| Trigger | Response |
|---------|----------|
| `help` or `?` | Show global help overview |
| `help invoice` | Show invoice commands |
| `invoice.create --help` | Show create invoice syntax |
| `invoice.create -h` | Same as above |
| Unknown command | "Did you mean...?" + help |

### 7.2 Help Display Format

**Global help** (`help`):
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HAASIB COMMAND HELP                                    [?] [√ó] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ QUICK START                                                     ‚îÇ
‚îÇ   inv new acme 1500        Create invoice for Acme, $1,500     ‚îÇ
‚îÇ   inv --unpaid             List unpaid invoices                ‚îÇ
‚îÇ   pay inv-1042 1500        Record payment for INV-1042         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ NAVIGATION                                                      ‚îÇ
‚îÇ   Tab          Autocomplete                                    ‚îÇ
‚îÇ   ‚Üë/‚Üì          History / suggestions                           ‚îÇ
‚îÇ   Esc          Close palette                                   ‚îÇ
‚îÇ   Cmd+Enter    Execute immediately                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ MODULES                                                         ‚îÇ
‚îÇ   invoice      Customer invoices (AR)                          ‚îÇ
‚îÇ   payment      Received payments                               ‚îÇ
‚îÇ   bill         Vendor bills (AP)                               ‚îÇ
‚îÇ   expense      Quick expenses                                  ‚îÇ
‚îÇ   report       Financial reports                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ Type "help <module>" for details                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Module help** (`help invoice`):
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ INVOICE COMMANDS                                       [?] [√ó] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ invoice.create    Create new invoice                           ‚îÇ
‚îÇ   inv new acme 1500                                            ‚îÇ
‚îÇ   invoice.create -c "Acme" -a 1500 --due="net 30"              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ invoice.list      List invoices                                ‚îÇ
‚îÇ   inv                     All invoices                         ‚îÇ
‚îÇ   inv --unpaid            Unpaid only                          ‚îÇ
‚îÇ   inv --overdue           Past due                             ‚îÇ
‚îÇ   inv -c acme             For specific customer                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ invoice.view      View invoice details                         ‚îÇ
‚îÇ   inv 1042                View INV-1042                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ invoice.send      Email invoice                                ‚îÇ
‚îÇ   inv send 1042           Send INV-1042                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ invoice.void      Void invoice                                 ‚îÇ
‚îÇ   inv void 1042           Void INV-1042 (requires confirm)     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Command help** (`invoice.create --help`):
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ invoice.create ‚Äî Create new invoice                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ USAGE                                                           ‚îÇ
‚îÇ   invoice.create <customer> <amount> [options]                 ‚îÇ
‚îÇ   inv new <customer> <amount> [options]                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ REQUIRED                                                        ‚îÇ
‚îÇ   customer    Customer name or ID                              ‚îÇ
‚îÇ   amount      Invoice amount                                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ OPTIONS                                                         ‚îÇ
‚îÇ   --due, -d       Due date (default: net 30)                   ‚îÇ
‚îÇ   --ref           Reference number                             ‚îÇ
‚îÇ   --notes, -n     Invoice notes                                ‚îÇ
‚îÇ   --draft         Save without posting to GL                   ‚îÇ
‚îÇ   --items         Line items (interactive if omitted)          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ EXAMPLES                                                        ‚îÇ
‚îÇ   inv new acme 1500                                            ‚îÇ
‚îÇ   inv new "Acme Corp" 1500 --due="jan 15"                      ‚îÇ
‚îÇ   invoice.create -c acme -a 1500 -d "net 30" -n "Q1 retainer"  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.3 Contextual Hints

While typing, show parsing feedback:

```
‚ùØ inv new acme 150
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ invoice.create                                             ‚îÇ
  ‚îÇ   customer: Acme Corp ‚úì                                    ‚îÇ
  ‚îÇ   amount: $150.00 ‚úì                                        ‚îÇ
  ‚îÇ   due: (default: net 30)                                   ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ Press Enter to create, Tab to add options                  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

When missing required params:

```
‚ùØ inv new acme
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ invoice.create                                             ‚îÇ
  ‚îÇ   customer: Acme Corp ‚úì                                    ‚îÇ
  ‚îÇ   amount: _____ ‚Üê required                                 ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ Add amount: inv new acme 1500                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 8. Undo & Confirmation

### 8.1 Action Classification

| Category | Examples | Behavior |
|----------|----------|----------|
| **Safe** | list, view, report | Execute immediately |
| **Reversible** | create, update | Execute, show undo option |
| **Destructive** | delete, void | Require confirmation |
| **Critical** | company.delete, bulk ops | Require typed confirmation |

### 8.2 Confirmation Flows

**Destructive action** (`invoice.void 1042`):
```
‚ùØ invoice.void 1042
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚ö†Ô∏è  VOID INVOICE                                           ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ Invoice: INV-1042                                          ‚îÇ
  ‚îÇ Customer: Acme Corp                                        ‚îÇ
  ‚îÇ Amount: $1,500.00                                          ‚îÇ
  ‚îÇ Status: Unpaid                                             ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ This will:                                                 ‚îÇ
  ‚îÇ   ‚Ä¢ Mark invoice as void                                   ‚îÇ
  ‚îÇ   ‚Ä¢ Reverse GL entries                                     ‚îÇ
  ‚îÇ   ‚Ä¢ Send void notification to customer                     ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ [y] Confirm    [n] Cancel    [Enter = Cancel]              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Critical action** (`company.delete acme`):
```
‚ùØ company.delete acme
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ üî¥ DELETE COMPANY                                          ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ Company: Acme Corp                                         ‚îÇ
  ‚îÇ Data: 1,247 invoices, 892 payments, 3 years of records     ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ ‚ö†Ô∏è  This action is IRREVERSIBLE.                           ‚îÇ
  ‚îÇ All data for this company will be permanently deleted.     ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ Type "delete acme" to confirm:                             ‚îÇ
  ‚îÇ ‚ùØ ________                                                 ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 8.3 Undo System

**For reversible actions**, show toast with undo:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úì Invoice INV-1043 created for Acme Corp ($1,500)         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  [View] [Undo - 8s]                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Undo window**: 10 seconds for most actions, 30 seconds for bulk ops.

**Undo implementation**:
- Store the inverse action with original params
- On undo, execute the inverse within a transaction
- Audit log records both original action and undo

```typescript
interface UndoableResult {
  success: true
  message: string
  data: any
  undo?: {
    action: string
    params: Record<string, any>
    expiresAt: number  // Unix timestamp
  }
}
```

### 8.4 Anomaly Warnings

Before executing, check for anomalies:

```
‚ùØ invoice.create acme 150000
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚ö†Ô∏è  UNUSUAL AMOUNT                                         ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ $150,000 is significantly higher than typical invoices     ‚îÇ
  ‚îÇ for Acme Corp (average: $2,400, max: $8,500).              ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ [c] Continue anyway    [e] Edit amount    [Esc] Cancel     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Anomalies to detect:
- Amount > 10x customer average
- Duplicate invoice (same customer + amount within 7 days)
- Posting to closed period
- Negative amounts (unless explicitly a credit)

---

## 9. Onboarding Strategy

### 9.1 Progressive Disclosure

**Level 0: Pure GUI** (Week 1)
- User doesn't know palette exists
- Subtle hint in corner: `Cmd+K for quick actions`
- No aggressive pushing

**Level 1: Awareness** (After 5 GUI actions)
- Toast after create: "Tip: `inv new acme 1500` does this faster"
- One-time modal: "Meet your command bar" (dismissable, never show again)

**Level 2: First Success** (After first palette use)
- Celebrate: "üéâ You just saved 8 seconds!"
- Suggest: "Try `inv --unpaid` to see unpaid invoices"

**Level 3: Habit Building** (After 10 palette uses)
- Show history: "Your recent commands..."
- Introduce TAB completion
- Suggest favorites

**Level 4: Power User** (After 50 palette uses)
- Introduce templates
- Introduce batch operations
- Reduce/eliminate GUI hints

### 9.2 "Learn as you click" Mode

When enabled (default for first 2 weeks):

Every GUI action shows the equivalent command:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Creating invoice...                                        ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  Command equivalent:                                        ‚îÇ
‚îÇ  invoice.create -c "Acme Corp" -a 1500 --due="2025-02-15"  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  [Copy command]  [Don't show these]                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 9.3 Beginner Mode (Menu-driven)

For users who open palette but don't know what to type:

```
‚ùØ (empty - press Enter for menu)
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ WHAT WOULD YOU LIKE TO DO?                      [1-6, ?]  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ                                                            ‚îÇ
  ‚îÇ  [1] üìÑ Create invoice                                     ‚îÇ
  ‚îÇ  [2] üí∞ Record payment                                     ‚îÇ
  ‚îÇ  [3] üìã View unpaid invoices                               ‚îÇ
  ‚îÇ  [4] üìä Run a report                                       ‚îÇ
  ‚îÇ  [5] ‚ûï Add customer or vendor                             ‚îÇ
  ‚îÇ  [6] ‚öôÔ∏è  Settings                                          ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ  [?] Help    [Esc] Close                                   ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îÇ  Or start typing a command...                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Selecting an option shows the command being built:

```
‚ùØ (Selected: Create invoice)
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ CREATE INVOICE                                             ‚îÇ
  ‚îÇ Command: invoice.create                                    ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ                                                            ‚îÇ
  ‚îÇ Customer: ________________  (type to search)               ‚îÇ
  ‚îÇ                                                            ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

As they fill fields, show the command building:

```
  ‚îÇ Command: invoice.create -c "Acme Corp" -a 1500            ‚îÇ
```

---

## 10. UI/UX Specification

### 10.1 Palette States

```
State: COLLAPSED (default)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ùØ Type command or Cmd+K...                       [‚ñ≠] [‚Äî] [‚õ∂] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

State: HALF (expanded)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ                      [ Main GUI - 50% ]                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ùØ invoice.create acme                            [‚ñ≠] [‚Äî] [‚õ∂] ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ invoice.create                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ   customer: Acme Corp ‚úì                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ   amount: _____ ‚Üê required                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ Suggestions:                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ   invoice.create acme 1500                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ   invoice.create acme 2500 --due="net 30"                   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ History: inv list --unpaid | pay inv-1041 800 | ...        ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

State: FULLSCREEN
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè¢ Acme Textiles ‚îÇ yasir ‚îÇ prod               [‚ñ≠] [‚Äî] [‚õ∂] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ ‚ùØ invoice.list --unpaid                                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ UNPAID INVOICES                               3 of 3 shown ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ INV#     Customer        Amount     Due        Status      ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ 1042     Acme Corp       $1,500.00  Jan 15     ‚ö†Ô∏è Overdue  ‚îÇ ‚îÇ
‚îÇ ‚îÇ 1043     Beta LLC        $2,200.00  Jan 20     Due in 5d   ‚îÇ ‚îÇ
‚îÇ ‚îÇ 1044     Gamma Inc       $800.00    Jan 25     Due in 10d  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ Total Outstanding: $4,500.00                                ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ [Enter] View  [s] Send  [a] Select all  [/] Filter  [?] Help   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 10.2 Color Semantics

| Element | Color | Hex | Usage |
|---------|-------|-----|-------|
| Success | Green | `#22c55e` | Completed actions, positive balances |
| Warning | Amber | `#f59e0b` | Overdue, anomalies, confirmations |
| Error | Red | `#ef4444` | Failed actions, negative states |
| Info | Blue | `#3b82f6` | Hints, suggestions, links |
| Muted | Gray | `#6b7280` | Secondary text, disabled |
| Selection | Indigo bg | `#4f46e5` | Highlighted row/option |

### 10.3 Keyboard Map

| Key | Context | Action |
|-----|---------|--------|
| `Cmd/Ctrl+K` | Global | Toggle palette |
| `Esc` | Palette | Close / shrink |
| `Enter` | Palette | Execute command / select |
| `Tab` | Palette | Autocomplete |
| `Shift+Tab` | Palette | Previous suggestion |
| `‚Üë` | Palette (empty) | Previous history |
| `‚Üì` | Palette | Next suggestion |
| `Cmd/Ctrl+Enter` | Palette | Execute immediately (skip confirm) |
| `Cmd/Ctrl+Shift+K` | Global | Palette fullscreen |
| `?` | Palette | Show help |
| `/` | List view | Filter |
| `j/k` | List view | Navigate rows |
| `Space` | List view | Toggle selection |
| `a` | List view | Select all |
| `y` | Confirmation | Confirm yes |
| `n` | Confirmation | Confirm no |

### 10.4 Accessibility Requirements

| Requirement | Implementation |
|-------------|----------------|
| Focus trap | Palette captures focus when open |
| Screen reader | `role="dialog"`, `aria-live` for results |
| Focus visible | 2px ring on all interactive elements |
| Motion | Respect `prefers-reduced-motion` |
| Touch targets | Minimum 44√ó44px for controls |
| Contrast | WCAG AA minimum (4.5:1 for text) |

---

## 11. Backend Contract

### 11.1 Endpoint

```
POST /api/commands

Headers:
  Authorization: Bearer <token> | Session cookie
  X-Action: <entity.verb>
  X-Idempotency-Key: <uuid>
  X-Company-Id: <tenant_id>  (optional, uses active company if omitted)

Body:
  {
    "params": { ... }
  }
```

### 11.2 Response Codes

| Code | Meaning | Body |
|------|---------|------|
| `200` | Success (query) | `{ ok: true, data, meta? }` |
| `201` | Success (mutation) | `{ ok: true, message, data, undo?, redirect? }` |
| `400` | Bad request | `{ ok: false, code: "BAD_REQUEST", message }` |
| `401` | Unauthorized | `{ ok: false, code: "UNAUTHORIZED" }` |
| `403` | Forbidden | `{ ok: false, code: "FORBIDDEN", message }` |
| `404` | Not found | `{ ok: false, code: "NOT_FOUND", message }` |
| `409` | Idempotent replay | `{ ok: false, code: "IDEMPOTENT_REPLAY", original }` |
| `422` | Validation failed | `{ ok: false, code: "VALIDATION", errors: {...} }` |
| `423` | Period locked | `{ ok: false, code: "PERIOD_LOCKED", message }` |
| `500` | Server error | `{ ok: false, code: "SERVER_ERROR" }` |

### 11.3 Command Bus

```php
// config/command-bus.php
return [
    // Foundations
    'company.create'    => \App\Actions\Company\Create::class,
    'company.delete'    => \App\Actions\Company\Delete::class,
    'company.assign'    => \App\Actions\Company\Assign::class,
    'company.unassign'  => \App\Actions\Company\Unassign::class,
    'user.create'       => \App\Actions\User\Create::class,
    'user.delete'       => \App\Actions\User\Delete::class,
    'user.update'       => \App\Actions\User\Update::class,

    // Accounting (Phase 2)
    'customer.create'   => \App\Actions\Customer\Create::class,
    'customer.list'     => \App\Actions\Customer\Index::class,
    'customer.view'     => \App\Actions\Customer\Show::class,
    'customer.update'   => \App\Actions\Customer\Update::class,
    'customer.delete'   => \App\Actions\Customer\Delete::class,

    'invoice.create'    => \App\Actions\Invoice\Create::class,
    'invoice.list'      => \App\Actions\Invoice\Index::class,
    'invoice.view'      => \App\Actions\Invoice\Show::class,
    'invoice.send'      => \App\Actions\Invoice\Send::class,
    'invoice.void'      => \App\Actions\Invoice\Void::class,

    // ... etc
];
```

### 11.4 Action Contract

```php
// app/Actions/Invoice/Create.php

namespace App\Actions\Invoice;

use App\Models\User;
use App\Models\Invoice;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Gate;
use Illuminate\Validation\ValidationException;

class Create
{
    public function handle(array $params, User $actor): array
    {
        // 1. Authorization
        Gate::forUser($actor)->authorize('invoice.create');

        // 2. Validation
        $validated = validator($params, [
            'customer_id' => 'required|exists:customers,id',
            'amount' => 'required|numeric|min:0.01',
            'due_date' => 'nullable|date|after:today',
            'line_items' => 'nullable|array',
            'notes' => 'nullable|string|max:1000',
            'draft' => 'nullable|boolean',
        ])->validate();

        // 3. Business logic
        return DB::transaction(function () use ($validated, $actor) {
            $invoice = Invoice::create([
                'company_id' => tenant_company_id(),
                'customer_id' => $validated['customer_id'],
                'amount' => $validated['amount'],
                'due_date' => $validated['due_date'] ?? now()->addDays(30),
                'status' => $validated['draft'] ?? false ? 'draft' : 'pending',
                'created_by' => $actor->id,
            ]);

            // Post to GL unless draft
            if (!($validated['draft'] ?? false)) {
                $this->postToLedger($invoice);
            }

            return [
                'message' => "Invoice {$invoice->number} created",
                'data' => $invoice->toArray(),
                'redirect' => "/invoices/{$invoice->id}",
                'undo' => [
                    'action' => 'invoice.void',
                    'params' => ['invoice_id' => $invoice->id],
                    'expiresAt' => now()->addSeconds(10)->unix(),
                ],
            ];
        });
    }
}
```

---

## 12. Performance Targets

### 12.1 Benchmarks

| Metric | Target | Measurement |
|--------|--------|-------------|
| Keypress ‚Üí suggestions | < 60ms p95 | Client-side timer |
| Enter ‚Üí optimistic UI | < 50ms | Client-side timer |
| Enter ‚Üí server confirmed | < 300ms p50, < 500ms p95 | Round-trip |
| Fuse index build | < 200ms | Worker completion |
| History lookup | < 10ms | IndexedDB read |

### 12.2 Optimization Strategies

**Client-side**:
- Web Worker for Fuse.js index building
- Debounce input (30ms) before searching
- Virtual list for large result sets
- Preload entity catalogs on palette focus
- Cache hot entities in memory (customers, accounts)

**Server-side**:
- Lightweight entity endpoints (id, name, search_text only)
- Redis cache for entity catalogs (5min TTL)
- Async audit logging (queue)
- Connection pooling for PostgreSQL

### 12.3 Monitoring

```typescript
// Emit performance events
window.dispatchEvent(new CustomEvent('haasib:perf', {
  detail: {
    event: 'command.execute',
    action: 'invoice.create',
    keystrokeToSuggestions: 45,  // ms
    enterToOptimistic: 30,       // ms
    enterToConfirmed: 280,       // ms
    success: true
  }
}));
```

Aggregate and alert on p95 regression > 20%.

---

## 13. Testing Strategy

### 13.1 Parser Tests (Unit)

```typescript
// tests/unit/parser.test.ts
describe('Parser', () => {
  describe('shortcut expansion', () => {
    test('inv ‚Üí invoice.list', () => {
      expect(parse('inv').action).toBe('invoice.list')
    })
    test('inv new ‚Üí invoice.create', () => {
      expect(parse('inv new').action).toBe('invoice.create')
    })
  })

  describe('forgiving input', () => {
    test('handles typos', () => {
      expect(parse('invocie.create').action).toBe('invoice.create')
    })
    test('order independent', () => {
      const a = parse('inv new acme 1500')
      const b = parse('inv new 1500 acme')
      expect(a.params).toEqual(b.params)
    })
  })

  describe('amount parsing', () => {
    test.each([
      ['1500', 1500],
      ['1500$', 1500],
      ['$1,500', 1500],
      ['1.5k', 1500],
    ])('%s ‚Üí %d', (input, expected) => {
      expect(parseAmount(input)).toBe(expected)
    })
  })
})
```

### 13.2 Action Tests (Integration)

```php
// tests/Feature/Commands/InvoiceCreateTest.php
class InvoiceCreateTest extends TestCase
{
    public function test_creates_invoice_with_valid_params()
    {
        $user = User::factory()->create();
        $company = Company::factory()->create();
        $customer = Customer::factory()->for($company)->create();

        $response = $this->actingAs($user)
            ->withHeaders([
                'X-Action' => 'invoice.create',
                'X-Idempotency-Key' => Str::uuid(),
                'X-Company-Id' => $company->id,
            ])
            ->postJson('/api/commands', [
                'params' => [
                    'customer_id' => $customer->id,
                    'amount' => 1500,
                ]
            ]);

        $response->assertStatus(201)
            ->assertJsonPath('ok', true)
            ->assertJsonStructure(['data' => ['id', 'number', 'amount']]);

        $this->assertDatabaseHas('invoices', [
            'customer_id' => $customer->id,
            'amount' => 1500,
        ]);
    }

    public function test_idempotent_replay_returns_409()
    {
        $key = Str::uuid();
        // First request succeeds
        $this->postCommand('invoice.create', [...], $key)
            ->assertStatus(201);

        // Second request with same key
        $this->postCommand('invoice.create', [...], $key)
            ->assertStatus(409)
            ->assertJsonPath('code', 'IDEMPOTENT_REPLAY');
    }
}
```

### 13.3 E2E Tests (Playwright)

```typescript
// tests/e2e/palette.spec.ts
test.describe('Command Palette', () => {
  test('opens with Cmd+K', async ({ page }) => {
    await page.goto('/dashboard')
    await page.keyboard.press('Meta+k')
    await expect(page.locator('[data-testid="palette"]')).toBeVisible()
  })

  test('creates invoice via command', async ({ page }) => {
    await page.goto('/dashboard')
    await page.keyboard.press('Meta+k')
    await page.keyboard.type('inv new acme 1500')
    await page.keyboard.press('Enter')

    // Wait for success toast
    await expect(page.locator('.toast-success')).toContainText('Invoice')
  })

  test('shows autocomplete suggestions', async ({ page }) => {
    await page.goto('/dashboard')
    await page.keyboard.press('Meta+k')
    await page.keyboard.type('inv')

    await expect(page.locator('[data-testid="suggestions"]'))
      .toContainText('invoice.create')
  })
})
```

### 13.4 Performance Probes

```python
# tools/perf_probe.py
import time
import statistics
from playwright.sync_api import sync_playwright

def measure_suggestion_latency(page, query):
    start = time.perf_counter()
    page.keyboard.type(query)
    page.wait_for_selector('[data-testid="suggestions"]')
    return (time.perf_counter() - start) * 1000

def run_probe():
    with sync_playwright() as p:
        browser = p.chromium.launch()
        page = browser.new_page()
        page.goto('http://localhost:8000/dashboard')
        page.keyboard.press('Meta+k')

        latencies = []
        for _ in range(20):
            page.keyboard.press('Escape')
            page.keyboard.press('Meta+k')
            latencies.append(measure_suggestion_latency(page, 'inv'))

        print(f"p50: {statistics.median(latencies):.1f}ms")
        print(f"p95: {statistics.quantiles(latencies, n=20)[18]:.1f}ms")

        browser.close()
```

---

## 14. Rollout Milestones

### Milestone 1: Foundations Complete (Current ‚Üí +2 weeks)
- [ ] Fix grammar inconsistency (standardize on `entity.verb`)
- [ ] Polish existing guided flow
- [ ] Add basic help system (`help`, `?`, `--help`)
- [ ] Implement undo for create actions
- [ ] Add confirmation for delete actions
- [ ] Performance baseline measurements

### Milestone 2: Accounting Core (+2 ‚Üí +7 weeks)
- [ ] `customer.*` commands
- [ ] `vendor.*` commands
- [ ] `invoice.*` commands with full flow
- [ ] `payment.*` commands
- [ ] `bill.*` commands
- [ ] `expense.*` commands
- [ ] Basic reports (`report.aging`, `report.profit-loss`)

### Milestone 3: Discoverability (+7 ‚Üí +9 weeks)
- [ ] GUI hint toasts (post-action tips)
- [ ] Button tooltips with command hints
- [ ] Empty state nudges
- [ ] "Learn as you click" mode
- [ ] Beginner menu mode
- [ ] User tenure tracking for hint frequency

### Milestone 4: Power Features (+9 ‚Üí +12 weeks)
- [ ] Command history (‚Üë/‚Üì)
- [ ] Favorites/pins
- [ ] Templates (save, list, run)
- [ ] Batch operations
- [ ] Export formats (CSV, JSON)
- [ ] Anomaly warnings

### Milestone 5: Polish & Intelligence (+12 ‚Üí +16 weeks)
- [ ] Natural language queries
- [ ] Personalized suggestions
- [ ] Comprehensive help content
- [ ] A11y audit and fixes
- [ ] Performance optimization pass
- [ ] User feedback integration

---

## 15. Command Reference

### 15.1 Company & Users

```bash
# Company management
company.list                      # List companies you have access to
company.create -name "Acme Corp"  # Create new company
company.switch acme               # Switch active company
company.delete acme               # Delete company (critical)

# User management
user.list                         # List users in current company
user.create -email joe@acme.com -role admin
user.update joe@acme.com -role member
user.delete joe@acme.com

# Assignments
company.assign joe@acme.com to acme -role admin
company.unassign joe@acme.com from acme
```

### 15.2 Customers & Vendors

```bash
# Customers (AR)
customer.create "Acme Corp" -email ar@acme.com
customer.list
customer.list --outstanding       # With balance > 0
customer.view acme
customer.update acme -email new@acme.com

# Vendors (AP)
vendor.create "Office Depot" -email ap@depot.com
vendor.list
vendor.list --owed                # With balance owed
vendor.view depot
```

### 15.3 Invoices & Payments

```bash
# Invoices
invoice.create acme 1500          # Quick create
invoice.create -c "Acme" -a 1500 --due="net 30" --notes="Q1 services"
invoice.list                      # All invoices
invoice.list --unpaid             # Unpaid only
invoice.list --overdue            # Past due
invoice.list -c acme              # For specific customer
invoice.view 1042                 # View INV-1042
invoice.send 1042                 # Email invoice
invoice.void 1042                 # Void invoice

# Shorthand
inv                               # ‚Üí invoice.list
inv new acme 1500                 # ‚Üí invoice.create
inv --unpaid                      # ‚Üí invoice.list --unpaid
inv 1042                          # ‚Üí invoice.view 1042

# Payments
payment.create 1042 1500          # Pay INV-1042 $1500
payment.create -inv 1042 -a 1500 --method bank --date today
payment.list
payment.list --today
payment.void 501

# Shorthand
pay 1042 1500                     # ‚Üí payment.create
```

### 15.4 Bills & Expenses

```bash
# Bills (AP)
bill.create depot 500             # Bill from Office Depot
bill.create -v "Office Depot" -a 500 --due="jan 30" --account supplies
bill.list
bill.list --unpaid
bill.pay 201 500                  # Pay bill

# Expenses (quick entry)
expense.create 50 --account meals --notes "Team lunch"
expense.list --from="jan 1" --to="jan 31"

# Shorthand
exp 50 meals "Team lunch"         # ‚Üí expense.create
```

### 15.5 Reports

```bash
report.list                       # Available reports
report.aging                      # AR aging (who owes me)
report.owed                       # AP aging (what I owe)
report.profit-loss --from="jan 1" --to="jan 31"
report.balance-sheet --as-of="jan 31"
report.cash-flow --period=q1
report.trial-balance

# Export
report.profit-loss --format=csv > pl-jan.csv
report.aging --format=json
```

### 15.6 Templates & Workflows

```bash
# Templates
template.save "monthly-rent" bill.create landlord 2500 --account rent
template.list
template.run monthly-rent

# Workflows
workflow.list
workflow.month-end                # Run month-end checklist
```

---

## Appendix A: Migration from cli.md v1

| v1 Pattern | v2 Pattern | Notes |
|------------|------------|-------|
| `invoice -c acme` | `invoice.list -c acme` | Explicit verb required |
| `invoice` (bare) | `invoice.list` | Shortcut expansion |
| `invoice:list` | `invoice.list` | Dot, not colon |
| Natural language queries | Deferred to Phase 4 | Scope control |
| Templates | Deferred to Phase 3 | Scope control |

## Appendix B: Glossary

| Term | Definition |
|------|------------|
| **Entity** | A domain object (invoice, customer, etc.) |
| **Verb** | An action on an entity (create, list, etc.) |
| **Palette** | The command input UI |
| **Guided flow** | Step-by-step field collection |
| **Freeform** | Direct command typing |
| **Idempotency key** | UUID preventing duplicate submissions |
| **Anomaly** | Unusual pattern triggering warning |

---

*Document version: 2.0*
*Last updated: 2025-01-15*
*Author: Claude + Yasir*


---

## Appendix C: Technology Stack

### Frontend (Palette)

| Layer | Technology | Purpose |
|-------|------------|---------|
| **Collapsed State** | Custom Vue 3 component | Lightweight input + suggestions |
| **Expanded State** | jQuery Terminal 2.45.x | Full terminal experience |
| **Styling** | Custom CSS (retro-future theme) | 80s aesthetic + modern touches |
| **Parser** | TypeScript (existing) | Freeform input ‚Üí structured command |
| **Search** | Fuse.js (Web Worker) | Fuzzy matching for autocomplete |
| **State** | IndexedDB + localStorage | History, preferences |
| **API Client** | Fetch + your existing apiPost | Command execution |

### Backend (Command Bus)

| Layer | Technology | Purpose |
|-------|------------|---------|
| **Endpoint** | `POST /api/commands` | Single entry point |
| **Router** | CommandBus (match dispatch) | Action resolution |
| **Actions** | Laravel Actions (per entity.verb) | Business logic |
| **Validation** | Laravel Validator | Input validation |
| **Authorization** | Laravel Policies + Gates | RBAC |
| **Idempotency** | Custom middleware + table | Prevent duplicates |
| **Audit** | AuditLog model | Command history |

### Integration Points

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ    ‚îÇ   Vue/Inertia    ‚îÇ        ‚îÇ  jQuery Terminal ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ      GUI         ‚îÇ        ‚îÇ     Palette      ‚îÇ            ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ             ‚îÇ                           ‚îÇ                       ‚îÇ
‚îÇ             ‚îÇ     Same Services         ‚îÇ                       ‚îÇ
‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ                         ‚îÇ                                       ‚îÇ
‚îÇ                         ‚ñº                                       ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ    ‚îÇ                    useCommandBus()                      ‚îÇ ‚îÇ
‚îÇ    ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ    ‚îÇ  - parse(input) ‚Üí { action, params, missing }          ‚îÇ ‚îÇ
‚îÇ    ‚îÇ  - execute(parsed) ‚Üí POST /api/commands                ‚îÇ ‚îÇ
‚îÇ    ‚îÇ  - getCompletions(partial) ‚Üí string[]                  ‚îÇ ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                         ‚îÇ                                       ‚îÇ
‚îÇ                         ‚ñº                                       ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ    ‚îÇ                   Laravel Backend                       ‚îÇ ‚îÇ
‚îÇ    ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ    ‚îÇ  CommandController ‚Üí CommandBus ‚Üí Actions ‚Üí Services   ‚îÇ ‚îÇ
‚îÇ    ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Package Dependencies

```json
{
  "dependencies": {
    "jquery": "^3.7.1",
    "jquery.terminal": "^2.45.2",
    "fuse.js": "^7.0.0"
  },
  "devDependencies": {
    "@types/jquery": "^3.5.29",
    "@types/jquery.terminal": "^2.37.2"
  }
}
```

### Why jQuery Terminal Over Alternatives

| Criterion | jQuery Terminal | xterm.js | vue-command-palette |
|-----------|-----------------|----------|---------------------|
| **Use case fit** | ‚úÖ Command interpreter | ‚ùå Shell emulator | ‚ö†Ô∏è Modern palette |
| **Autocomplete** | ‚úÖ Built-in | ‚ùå DIY | ‚úÖ Built-in |
| **History** | ‚úÖ Built-in | ‚ùå DIY | ‚ö†Ô∏è Basic |
| **Color syntax** | ‚úÖ Simple `[[;color;]text]` | ‚ö†Ô∏è ANSI escapes | ‚ùå CSS only |
| **Retro aesthetic** | ‚úÖ Natural fit | ‚úÖ Natural fit | ‚ùå Modern design |
| **JSON-RPC** | ‚úÖ Native | ‚ùå None | ‚ùå None |
| **Bundle size** | 150KB | 400KB | 15KB |
| **Learning curve** | Low | Medium | Low |

**Verdict**: jQuery Terminal is purpose-built for fake terminals / command interpreters, which is exactly our use case. xterm.js would be overkill (and require building everything jQuery Terminal provides out of the box).


